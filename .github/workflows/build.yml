
name: Build ESP-IDF Toolchain (Alpine/Musl Static) - ANDROID NATIVE FIX

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  # Variabel ini PENTING agar ct-ng mau jalan sebagai root
  CT_ALLOW_BUILD_AS_ROOT: 'y'
  CT_ALLOW_BUILD_AS_ROOT_SURE: 'y'

jobs:
  compile-alpine:
    runs-on: ubuntu-22.04-arm
    
    container:
      image: alpine:3.15
      options: --privileged

    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Install Dependencies (Alpine)
        run: |
          echo "Installing Alpine Dependencies..."
          apk update
          apk add --no-cache \
            build-base git bash bison flex texinfo gawk help2man \
            libtool ncurses-dev python3 python3-dev unzip wget \
            xz automake autoconf shadow file patch \
            linux-headers gettext-dev tar gzip bzip2

          # Link python3 ke python
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare Workspace
        run: |
          # Kita pindahkan ke folder kerja yang aman
          mkdir -p /workdir
          cp -r repo/* /workdir/
          cd /workdir
          
          rm -rf crosstool-ng .build x-tools artifacts
          mkdir -p x-tools artifacts

      - name: Download & Install crosstool-NG
        working-directory: /workdir
        run: |
          echo "Mengunduh crosstool-NG branch: $CROSSTOOL_NG_VERSION"
          git clone https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          
          cd crosstool-ng
          echo "=== INIT SUBMODULES ==="
          git submodule update --init --recursive
          
          # Fix timestamp agar autoconf tidak bingung
          find . -exec touch {} +
          
          ./bootstrap
          ./configure --enable-local --prefix=$PWD/install
          make -j$(nproc)
          make install

      - name: Siapkan Config & Patch
        working-directory: /workdir
        env:
          TARGET: ${{ matrix.target }}
        run: |
          # Masukkan ct-ng ke PATH
          export PATH=$PWD/crosstool-ng/install/bin:$PATH
          mkdir -p .build/tarballs
          
          cd crosstool-ng
          
          # 1. Generate Config Awal
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            cp samples/$TARGET/crosstool.config .config
          else
            ct-ng $TARGET
          fi

          # 2. Bersihkan Config Lama
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_LogFile/d' .config
          sed -i '/CT_ALLOW_BUILD_AS_ROOT/d' .config
          
          # 3. Inject Config BARU (MUSL STATIC + ROOT FORCE)
          cat >> .config <<EOF
          
          # Paths (Gunakan path absolut dalam container)
          CT_PREFIX_DIR="/workdir/x-tools/${TARGET}"
          CT_LOCAL_TARBALLS_DIR="/workdir/.build/tarballs"
          
          # Build Options
          CT_PARALLEL_JOBS=$(nproc)
          CT_LOG_PROGRESS_BAR=n
          CT_Experimental=y
          
          # FORCE ROOT (Wajib di container ini)
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          # --- KUNCI KEBERHASILAN DI TERMUX (MUSL) ---
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y
          CT_GDB_CROSS_PYTHON=n
          CT_GDB_CROSS_PYTHON_BINARY=""
          CT_WERROR=n
          # -------------------------------------------
          
          # ESP32 Specifics
          CT_TARGET_VENDOR="esp32"
          CT_OVERLAY_NAME="esp32"
          CT_OVERLAY_LOCATION="/workdir/crosstool-ng/overlays"
          EOF
          
          # Fix Kernel Version check
          sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config

          # Update config
          yes "" | ct-ng oldconfig

      - name: Build Toolchain
        id: build
        working-directory: /workdir
        run: |
          export PATH=$PWD/crosstool-ng/install/bin:$PATH
          cd crosstool-ng
          
          # Fix ISL download manual
          cd ../.build/tarballs
          wget --no-check-certificate -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2 || true
          cd ../../crosstool-ng
          
          echo "Memulai Build di Alpine (Musl) sebagai ROOT..."
          # Kita set lagi env var untuk memastikan
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Packaging
        if: steps.build.outputs.success == 'true'
        working-directory: /workdir
        run: |
          echo "Checking binary type..."
          file x-tools/${{ matrix.target }}/bin/*-gcc | head -n 1
          
          ARTIFACT_NAME="${{ matrix.target }}-gcc8_4_0-musl-static-native-android.tar.gz"
          
          cd x-tools
          tar -czf ../artifacts/$ARTIFACT_NAME *
          
          # Pindahkan artifact kembali ke workspace GitHub agar bisa di-upload
          cp ../artifacts/$ARTIFACT_NAME $GITHUB_WORKSPACE/
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-android-native-fixed
          path: ${{ github.workspace }}/${{ env.ARTIFACT_NAME }}
          retention-days: 30

      - name: Upload Logs (If Fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: /workdir/crosstool-ng/build.log
