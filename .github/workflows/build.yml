name: Build ESP-IDF Toolchains (ARM64 Host) - SYMLINK FIX

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Bersihkan Workspace
        run: |
          echo "Membersihkan workspace..."
          rm -rf crosstool-ng .build x-tools artifacts
          mkdir -p x-tools artifacts

      - name: Set Environment Variables
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf automake bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev libncursesw5-dev \
            python3 python3-dev python3-distutils python3-pip \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils lzip gzip curl rsync \
            libgmp-dev libmpfr-dev libmpc-dev libexpat1-dev zlib1g-dev \
            g++ gcc make patch gettext
          
          # Fix python3 symlink
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download & Install crosstool-NG
        run: |
          echo "Mengunduh crosstool-NG branch: $CROSSTOOL_NG_VERSION"
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          sudo make install

      - name: Siapkan Folder Tarballs
        run: |
          mkdir -p $WORKSPACE/.build/tarballs
          echo "CT_LOCAL_TARBALLS_DIR=$WORKSPACE/.build/tarballs" >> $GITHUB_ENV

      - name: Download Manual Library (ISL FIX)
        run: |
          echo "=== DOWNLOAD MANUAL DEPENDENCIES ==="
          cd $CT_LOCAL_TARBALLS_DIR
          
          # 1. ISL 0.19 (CRITICAL)
          wget --tries=5 --waitretry=5 -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2
          
          # 2. GMP 6.2.0
          if [ ! -f "gmp-6.2.0.tar.xz" ]; then
             wget --tries=5 -O gmp-6.2.0.tar.xz https://ftp.gnu.org/gnu/gmp/gmp-6.2.0.tar.xz
          fi
          
          # 3. MPFR 4.0.2
          if [ ! -f "mpfr-4.0.2.tar.xz" ]; then
             wget --tries=5 -O mpfr-4.0.2.tar.xz https://ftp.gnu.org/gnu/mpfr/mpfr-4.0.2.tar.xz
          fi
          
          # 4. MPC 1.1.0
          if [ ! -f "mpc-1.1.0.tar.gz" ]; then
             wget --tries=5 -O mpc-1.1.0.tar.gz https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
          fi

          # Validasi ISL
          if [ ! -s isl-0.19.tar.bz2 ] || [ $(stat -c%s "isl-0.19.tar.bz2") -lt 100000 ]; then
            rm -f isl-0.19.tar.bz2
            wget --tries=5 -O isl-0.19.tar.bz2 https://libisl.sourceforge.io/isl-0.19.tar.bz2
          fi

      - name: Konfigurasi Toolchain (SYMLINK STRATEGY)
        run: |
          cd $WORKSPACE/crosstool-ng
          
          # --- STRATEGI SYMLINK ANTI-GAGAL ---
          echo "=== MEMBUAT SYMLINK OVERLAYS ==="
          cd overlays
          
          # Cek folder asli
          if [ -d "xtensa_esp32" ]; then
             echo "Folder asli 'xtensa_esp32' ditemukan."
             
             # Buat symlink untuk semua kemungkinan nama yang mungkin dicari ct-ng
             # 1. Jika dia mencari 'xtensa_xtensa_esp32' (Double prefix)
             ln -s xtensa_esp32 xtensa_xtensa_esp32
             
             # 2. Jika dia mencari 'esp32' (Tanpa prefix)
             ln -s xtensa_esp32 esp32
             
             echo "Symlinks dibuat. Daftar folder overlays:"
             ls -la
          else
             echo "FATAL: Folder overlays/xtensa_esp32 tidak ditemukan!"
             ls -la
             exit 1
          fi
          cd ..
          
          # --- KONFIGURASI CONFIG ---
          echo "=== 1. Load Sample Config ==="
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            cp samples/$TARGET/crosstool.config .config
          else
            ./ct-ng $TARGET
          fi

          echo "=== 2. Hapus Variabel ==="
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_HOST/d' .config
          sed -i '/CT_PARALLEL_JOBS/d' .config
          sed -i '/CT_TARGET/d' .config
          sed -i '/CT_ARCH/d' .config
          sed -i '/CT_GDB_CROSS_PYTHON_BINARY/d' .config
          sed -i '/CT_OVERLAY_LOCATION/d' .config
          sed -i '/CT_OVERLAY_NAME/d' .config

          echo "=== 3. Inject Variabel ==="
          cat >> .config <<EOF
          
          # --- CI CONFIGURATION ---
          CT_TARGET="$TARGET"
          
          # Fix Arsitektur
          CT_ARCH="xtensa"
          CT_ARCH_XTENSA=y
          
          # FIX OVERLAY: Kita set "esp32", ct-ng akan mencari "xtensa_esp32"
          # Kalaupun dia mencari nama lain, symlink di atas sudah menanganinya.
          CT_OVERLAY_NAME="esp32"
          CT_OVERLAY_LOCATION="$WORKSPACE/crosstool-ng/overlays"
          
          # Environment
          CT_HOST="$CT_HOST_TRIPLET"
          CT_PREFIX_DIR="$CT_PREFIX_DIR"
          CT_LOCAL_TARBALLS_DIR="$CT_LOCAL_TARBALLS_DIR"
          CT_PARALLEL_JOBS=$(nproc)
          CT_LOG_PROGRESS_BAR=n
          
          # Izin & Python
          CT_EXPERIMENTAL=y
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_GDB_CROSS_PYTHON_BINARY="python3"
          EOF

          echo "=== 4. Khusus ESP32 Core ==="
          if [[ "$TARGET" == *"esp32"* ]]; then
             if ! grep -q "CT_ARCH_XTENSA_CORE" .config; then
                echo 'CT_ARCH_XTENSA_CORE="esp32"' >> .config
             fi
             if grep -q "CT_KERNEL" .config; then
                sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config
             else
                echo 'CT_KERNEL="none"' >> .config
             fi
          fi

          echo "=== 5. Jalankan Oldconfig ==="
          yes "" | ./ct-ng oldconfig

      - name: Build Toolchain
        id: build
        run: |
          cd $WORKSPACE/crosstool-ng
          
          rm -rf .build/$TARGET
          export CT_NG_BUILD_FORCE=1
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          export HOME=$WORKSPACE
          
          echo "Memulai build... (Estimasi: 45-60 menit)"
          ./ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Package Toolchain
        if: steps.build.outputs.success == 'true'
        id: package
        run: |
          if [ ! -f "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" ]; then
             echo "FATAL: GCC binary tidak ditemukan!"
             exit 1
          fi

          ARTIFACT_NAME="${TARGET}-gcc8_4_0-${CROSSTOOL_NG_VERSION}-linux-arm64.tar.gz"
          cd "$CT_PREFIX_DIR"
          tar -czf "$WORKSPACE/artifacts/$ARTIFACT_NAME" "$TARGET"
          
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-arm64
          path: ${{ env.WORKSPACE }}/artifacts/
          retention-days: 30

      - name: Upload Log Jika Gagal
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs
          path: |
            ${{ env.WORKSPACE }}/crosstool-ng/build.log
            ${{ env.WORKSPACE }}/crosstool-ng/.config
          retention-days: 5