name: üé¨ AI Director Ultra (MoviePy Edition)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4/YouTube'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Target Jumlah Klip'
        required: false
        default: '3'
      platform:
        description: 'Platform Target'
        required: false
        default: 'tiktok'
        type: choice
        options:
          - tiktok
          - youtube_shorts
          - instagram_reels

jobs:
  ai-director-moviepy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: üìÅ Setup Workspace
        run: mkdir -p workspace output
          
      - name: ‚ö° Checkout Repository
        uses: actions/checkout@v4
        
      - name: üêç Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: üîß Install System Dependencies
        run: |
          sudo apt-get update -y
          # MoviePy butuh ffmpeg system level juga untuk backend
          sudo apt-get install -y ffmpeg libsm6 libxext6
          
      - name: üì¶ Install Python Libraries
        run: |
          python -m pip install --upgrade pip
          
          # AI & Transkripsi
          pip install git+https://github.com/openai/whisper.git
          pip install openai==0.28.1
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          
          # Video Processing (MOVIEPY - Library Khusus Video)
          pip install moviepy==1.0.3
          pip install imageio-ffmpeg
          pip install decorator==4.4.2
          
          # Utilities
          pip install yt-dlp requests tqdm
          
      - name: üöÄ Run AI Director (MoviePy Core)
        env:
          OPENAI_API_KEY: "Kontolondon" # Ganti/Gunakan Secrets
          OPENAI_API_BASE: "https://tes-coral.vercel.app/v1/"
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
        run: |
          cat > director.py << 'EOF'
          import os
          import sys
          import json
          import re
          import logging
          from pathlib import Path
          import whisper
          import yt_dlp
          
          # === IMPORT MOVIEPY ===
          # Library ini akan menangani semua urusan FFmpeg
          from moviepy.editor import VideoFileClip, vfx
          
          # Setup Logging Verbose
          logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
          logger = logging.getLogger(__name__)

          # Config
          VIDEO_URL = os.getenv("VIDEO_URL")
          NUM_SHORTS = int(os.getenv("NUM_SHORTS", 3))
          WORKDIR = Path("workspace")
          OUTDIR = Path("output")
          
          def download_video():
              logger.info(f"üì• Downloading: {VIDEO_URL}")
              target = WORKDIR / "input.mp4"
              if target.exists(): target.unlink()
              
              opts = {
                  'format': 'best[ext=mp4]/best',
                  'outtmpl': str(target),
                  'quiet': True
              }
              with yt_dlp.YoutubeDL(opts) as ydl:
                  ydl.download([VIDEO_URL])
              
              if target.exists():
                  logger.info(f"‚úÖ Video Downloaded: {target.stat().st_size / 1024 / 1024:.2f} MB")
                  return target
              raise Exception("Download failed")

          def transcribe_video(path):
              logger.info("üé§ Transcribing Audio (Whisper)...")
              model = whisper.load_model("medium", device="cpu") # Force CPU
              result = model.transcribe(str(path), verbose=True) # Verbose output
              return result['segments']

          def analyze_content(segments):
              logger.info("üß† Analyzing Content (GPT-4)...")
              # Simple transcript prep
              text = " ".join([s['text'] for s in segments[:50]]) # First 50 segments
              
              prompt = f"""
              Analyze this transcript and find {NUM_SHORTS} viral short clips.
              Transcript: {text[:2000]}...
              
              Return ONLY JSON Array:
              [
                {{"start": 10, "end": 20, "title": "Funny Moment"}},
                {{"start": 45, "end": 60, "title": "Shocking Twist"}}
              ]
              """
              
              try:
                  import openai
                  openai.api_key = os.getenv("OPENAI_API_KEY")
                  openai.api_base = os.getenv("OPENAI_API_BASE")
                  
                  res = openai.ChatCompletion.create(
                      model="gpt-4",
                      messages=[{"role": "user", "content": prompt}]
                  )
                  content = res.choices[0].message.content
                  match = re.search(r'\[.*\]', content, re.DOTALL)
                  if match:
                      return json.loads(match.group())
              except Exception as e:
                  logger.error(f"AI Failed: {e}")
              
              # Fallback logic
              logger.warning("‚ö†Ô∏è Using Fallback Clips")
              return [{'start': i*30, 'end': i*30+15, 'title': f'Clip_{i}'} for i in range(NUM_SHORTS)]

          def process_clips_moviepy(video_path, clips):
              logger.info("üé¨ Processing Video with MoviePy...")
              
              # Load Video Utama
              # Menggunakan context manager agar memory aman
              with VideoFileClip(str(video_path)) as video:
                  logger.info(f"‚ÑπÔ∏è Source Info: {video.w}x{video.h}, {video.duration}s, {video.fps}fps")
                  
                  for i, clip_data in enumerate(clips):
                      try:
                          start = float(clip_data['start'])
                          end = float(clip_data['end'])
                          title = re.sub(r'\W+', '_', clip_data['title'])
                          
                          output_name = f"{title}_{i+1}.mp4"
                          output_path = OUTDIR / output_name
                          
                          logger.info(f"‚úÇÔ∏è Cutting Clip {i+1}: {start}s - {end}s")
                          
                          # 1. POTONG (SUBCLIP)
                          subclip = video.subclip(start, end)
                          
                          # 2. LOGIKA 9:16 (VERTICAL)
                          # Kita resize tinggi ke 1920 dulu (aspek rasio tetap)
                          # Lalu kita crop tengah selebar 1080
                          if subclip.h != 1920:
                              subclip = subclip.resize(height=1920)
                          
                          # Crop Center 1080px Width
                          x_center = subclip.w / 2
                          subclip = subclip.crop(
                              x1=x_center - 540, 
                              width=1080,
                              height=1920
                          )
                          
                          # 3. EXPORT / RENDER
                          # preset='fast' biar cepet di Github Actions
                          # codec='libx264' standar MP4
                          # audio_codec='aac' standar audio
                          # ffmpeg_params=['-pix_fmt', 'yuv420p'] -> WAJIB AGAR PLAYABLE DI HP
                          
                          subclip.write_videofile(
                              str(output_path),
                              codec='libx264',
                              audio_codec='aac',
                              preset='fast',
                              ffmpeg_params=['-pix_fmt', 'yuv420p'], 
                              verbose=True,   # Tampilkan log lengkap FFmpeg
                              logger='bar'    # Tampilkan progress bar
                          )
                          
                          logger.info(f"‚úÖ Success: {output_name}")
                          
                      except Exception as e:
                          logger.error(f"‚ùå Failed processing clip {i}: {e}")

          def main():
              try:
                  video = download_video()
                  segments = transcribe_video(video)
                  clips = analyze_content(segments)
                  process_clips_moviepy(video, clips)
              except Exception as e:
                  logger.error(f"Fatal Error: {e}")
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF
          
          echo "üöÄ Starting Python Director..."
          python director.py
          
      - name: üì¶ Upload Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: viral-videos
          path: output/*.mp4
          retention-days: 3
