name: Build ESP-IDF Toolchains (ARM64 Host) - Final Fixed

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: false

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean workspace
        run: |
          echo "Cleaning workspace..."
          rm -rf crosstool-ng crosstool-NG .config* .build x-tools overlays
          mkdir -p x-tools

      - name: Set environment variables
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf automake bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev libncursesw5-dev \
            python3 python3-dev python3-distutils python3-pip \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils lzip gzip curl rsync \
            libgmp-dev libmpfr-dev libmpc-dev libexpat1-dev zlib1g-dev \
            g++ gcc make patch gettext
          # Ensure python command exists for legacy scripts
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download crosstool-NG fork
        run: |
          echo "Downloading Espressif crosstool-NG fork..."
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng

      - name: Build and install crosstool-NG
        run: |
          cd $WORKSPACE/crosstool-ng
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          sudo make install
          echo "crosstool-NG version:"
          ct-ng --version || echo "ct-ng not found"

      - name: Setup build directories
        run: |
          mkdir -p $WORKSPACE/.build/tarballs
          mkdir -p $WORKSPACE/.build/src
          echo "CT_LOCAL_TARBALLS_DIR=$WORKSPACE/.build/tarballs" >> $GITHUB_ENV

      - name: Pre-download tarballs
        run: |
          echo "Downloading essential tarballs..."
          mkdir -p $CT_LOCAL_TARBALLS_DIR
          cd $CT_LOCAL_TARBALLS_DIR
          
          # Download common dependencies to avoid timeout during build
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz || echo "Failed gmp"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz || echo "Failed mpfr"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz || echo "Failed mpc"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/binutils/binutils-2.36.1.tar.xz || echo "Failed binutils"
          
          echo "Available tarballs:"
          ls -la *.tar.* 2>/dev/null | wc -l

      - name: Create proper configuration
        run: |
          cd $WORKSPACE/crosstool-ng
          
          echo "=== CREATING CONFIGURATION FOR $TARGET ==="
          
          # 1. Start with the sample config if available, or generate a default
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            echo "Base: Using sample configuration from samples/$TARGET"
            cp samples/$TARGET/crosstool.config .config
          else
            echo "Base: Using internal default for $TARGET"
            ./ct-ng $TARGET
          fi
          
          # 2. FORCE OVERRIDES (This fixes the missing variables error)
          echo "Applying CI-specific overrides..."
          
          # Remove existing lines to avoid conflicts/duplicates
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_HOST/d' .config
          sed -i '/CT_PARALLEL_JOBS/d' .config
          sed -i '/CT_LOG_PROGRESS_BAR/d' .config
          sed -i '/CT_TARGET/d' .config
          sed -i '/CT_GDB_CROSS_PYTHON_BINARY/d' .config
          
          # Append strict configurations
          cat >> .config <<EOF
          
          # CI Overrides
          CT_TARGET="$TARGET"
          CT_HOST="$CT_HOST_TRIPLET"
          CT_PREFIX_DIR="$CT_PREFIX_DIR"
          CT_LOCAL_TARBALLS_DIR="$CT_LOCAL_TARBALLS_DIR"
          CT_PARALLEL_JOBS=$(nproc)
          CT_LOG_PROGRESS_BAR=n
          CT_EXPERIMENTAL=y
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          # Ensure Python3 is used (Ubuntu 22.04 does not have python2)
          CT_GDB_CROSS_PYTHON_BINARY="python3"
          EOF
          
          # 3. Ensure Kernel is none (Bare Metal) for ESP32
          if ! grep -q "CT_KERNEL" .config; then
             echo 'CT_KERNEL="none"' >> .config
          fi
          
          # 4. Final check for specific ESP32 requirements
          if [[ "$TARGET" == *"esp32"* ]]; then
            # Ensure custom is set if relying on sample
            if ! grep -q "CT_ARCH_XTENSA_CORE" .config; then
               echo 'CT_ARCH_XTENSA_CORE="esp32"' >> .config
            fi
          fi
          
          echo "=== FINAL CONFIGURATION HEAD ==="
          head -n 20 .config
          echo "..."
          echo "=== CI VARIABLES IN CONFIG ==="
          grep -E "CT_HOST|CT_PREFIX|CT_TARGET" .config

      - name: Verify configuration
        run: |
          cd $WORKSPACE/crosstool-ng
          echo "=== VERIFYING CONFIGURATION ==="
          
          REQUIRED_SETTINGS=("CT_TARGET" "CT_HOST" "CT_PREFIX_DIR" "CT_LOCAL_TARBALLS_DIR")
          MISSING=0
          
          for setting in "${REQUIRED_SETTINGS[@]}"; do
            if grep -q "^$setting=" .config; then
              echo "✓ $setting is set"
            else
              echo "✗ ERROR: $setting is MISSING in .config"
              MISSING=1
            fi
          done
          
          if [ $MISSING -eq 1 ]; then
            echo "Configuration is incomplete. Aborting."
            exit 1
          fi

      - name: Build toolchain
        id: build
        run: |
          cd $WORKSPACE/crosstool-ng
          
          # Clean previous build artifacts
          rm -rf .build/$TARGET
          
          export CT_NG_BUILD_FORCE=1
          export CT_EXPERIMENTAL=y
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          export HOME=$WORKSPACE
          
          mkdir -p $WORKSPACE/.build/logs
          
          echo "Starting ct-ng build for $TARGET..."
          echo "Host: $CT_HOST_TRIPLET"
          
          # Using standard output for logs to keep CI alive
          ./ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Test and package toolchain
        if: steps.build.outputs.success == 'true'
        id: package
        run: |
          echo "=== PACKAGING TOOLCHAIN ==="
          
          if [ ! -d "$CT_PREFIX_DIR/$TARGET" ]; then
             echo "Error: Toolchain directory not found at $CT_PREFIX_DIR/$TARGET"
             exit 1
          fi
          
          # Verify binary executable on ARM64
          if [ -f "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" ]; then
             echo "Verifying GCC binary..."
             file "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc"
             "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" --version | head -1
          else
             echo "Error: GCC binary not found"
             exit 1
          fi
          
          mkdir -p $WORKSPACE/artifacts
          TIMESTAMP=$(date +%Y%m%d)
          # Standard Espressif naming convention usually: xtensa-esp32-elf-gcc8_4_0-esp-2021r2-linux-arm64.tar.gz
          ARTIFACT_NAME="${TARGET}-gcc8_4_0-${CROSSTOOL_NG_VERSION}-linux-arm64.tar.gz"
          
          echo "Compressing $ARTIFACT_NAME..."
          # cd to prefix dir to package relatively
          cd "$CT_PREFIX_DIR"
          tar -czf "$WORKSPACE/artifacts/$ARTIFACT_NAME" "$TARGET"
          
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "artifact_path=$WORKSPACE/artifacts/$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-arm64
          path: ${{ env.WORKSPACE }}/artifacts/
          retention-days: 30

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build.log
          path: |
            ${{ env.WORKSPACE }}/.build/logs/
            ${{ env.WORKSPACE }}/crosstool-ng/.config
            ${{ env.WORKSPACE }}/crosstool-ng/build.log