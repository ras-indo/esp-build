# .github/workflows/build-esp-idf-toolchains-arm64.yml
name: Build ESP-IDF Toolchains (ARM64 Host)

on:
  workflow_dispatch:
    inputs:
      do_release:
        description: Create GitHub Release and upload toolchains
        required: true
        type: boolean
        default: false
      release:
        description: Release tag / name (example: v1.0.0)
        required: true
        type: string

permissions:
  contents: write

# Keep top-level env simple and free of GH expression interpolation to avoid YAML parse issues.
env:
  CROSSTOOL_NG_VERSION: "1.26.0"
  CT_HOST_TRIPLET: "aarch64-unknown-linux-gnu"
  # Use runner path that is always present: /github/workspace
  CT_PREFIX_DIR: "/github/workspace/x-tools"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create GitHub Release
        id: create_release
        if: ${{ github.event.inputs.do_release == 'true' }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event.inputs.release }}
          name: ${{ github.event.inputs.release }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  compile:
    needs: prepare
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - xtensa-lx106-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify runner architecture (ARM64)
        run: |
          echo "uname:"
          uname -a
          echo "lscpu summary:"
          lscpu | sed -n '1,6p'

      - name: Set environment
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=${{ env.CT_PREFIX_DIR }}" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV

      - name: Cache toolchains and ct-ng cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            x-tools
            ~/.cache/ct-ng
          key: arm64-ctng-${{ matrix.target }}-${{ env.CROSSTOOL_NG_VERSION }}

      - name: Install build dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev \
            python3 python3-dev python3-distutils \
            git wget unzip pkg-config ca-certificates
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Build and install crosstool-NG
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          wget -q http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-${CROSSTOOL_NG_VERSION}.tar.bz2
          tar xf crosstool-ng-${CROSSTOOL_NG_VERSION}.tar.bz2
          cd crosstool-ng-${CROSSTOOL_NG_VERSION}
          ./configure --enable-local
          make -j$(nproc)
          sudo make install

      - name: Configure crosstool-NG for ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng-${CROSSTOOL_NG_VERSION}
          ./ct-ng $TARGET

          # Ensure outputs go to workspace/x-tools and host triplet = ARM64
          echo "CT_PREFIX_DIR=\"${CT_PREFIX_DIR}\"" >> .config
          echo "CT_HOST=\"${CT_HOST_TRIPLET}\"" >> .config

          # ESP toolchains are bare-metal / newlib
          echo "CT_KERNEL_BARE_METAL=y" >> .config
          echo "CT_LIBC_NEWLIB=y" >> .config
          echo "CT_LIBC=\"newlib\"" >> .config

          # C++ support and clean logs
          echo "CT_CC_LANG_CXX=y" >> .config
          echo "CT_LOG_PROGRESS_BAR=n" >> .config

          # Save a copy for debugging
          cp .config $GITHUB_WORKSPACE/.config-${TARGET}
          echo "---- .config tail ----"
          tail -n 60 .config || true
          echo "---- end .config ----"

      - name: Build toolchain ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng-${CROSSTOOL_NG_VERSION}
          cp $GITHUB_WORKSPACE/.config-${TARGET} .config || true
          export HOME=$GITHUB_WORKSPACE
          mkdir -p "${CT_PREFIX_DIR}"
          ./ct-ng build 2>&1 | tee build-${TARGET}.log || true

      - name: Verify toolchain
        run: |
          TOOLCHAIN_BIN="${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc"
          echo "Checking: $TOOLCHAIN_BIN"
          if [ -x "$TOOLCHAIN_BIN" ]; then
            "$TOOLCHAIN_BIN" --version || true
            echo 'int main(){return 0;}' > test.c
            "$TOOLCHAIN_BIN" test.c -o test.elf || true
            file test.elf || true
          else
            echo "Toolchain binary not found: $TOOLCHAIN_BIN"
            exit 1
          fi

      - name: Package toolchain
        id: package
        run: |
          mkdir -p artifacts
          ASSET="${TARGET}-host-arm64.tar.gz"
          if [ -d "${CT_PREFIX_DIR}/${TARGET}" ]; then
            tar -C "${CT_PREFIX_DIR}" -czf "artifacts/${ASSET}" "${TARGET}"
          else
            tar -C "${CT_PREFIX_DIR}" -czf "artifacts/${ASSET}" .
          fi
          sha256sum "artifacts/${ASSET}" > "artifacts/${ASSET}.sha256"
          echo "asset=${ASSET}" >> $GITHUB_OUTPUT
          echo "asset_path=artifacts/${ASSET}" >> $GITHUB_OUTPUT

      - name: Upload artifact (CI)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset }}
          path: |
            ${{ steps.package.outputs.asset_path }}
            ${{ steps.package.outputs.asset_path }}.sha256

      - name: Upload to GitHub Release
        if: ${{ github.event.inputs.do_release == 'true' }}
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ needs.prepare.outputs.upload_url }}
          asset_path: ${{ steps.package.outputs.asset_path }}
          asset_name: ${{ steps.package.outputs.asset }}
          asset_content_type: application/gzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: [prepare, compile]
    if: ${{ github.event.inputs.do_release == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksum summary
        run: |
          echo "# ESP-IDF Toolchain Checksums" > summary.md
          echo '```' >> summary.md
          find artifacts -name "*.sha256" | sort | while read f; do
            echo "## $(basename "${f}")" >> summary.md
            cat "$f" >> summary.md
            echo "" >> summary.md
          done
          echo '```' >> summary.md

      - name: Update release body
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ github.event.inputs.release }}
          bodyFile: summary.md
          token: ${{ secrets.GITHUB_TOKEN }}
