name: Build ESP-IDF Toolchains (ARM64 Host) - Auto Fix

on:
  push:
    branches:
      - 'main'

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean workspace dari konfigurasi lama
        run: |
          echo "Membersihkan workspace dari konfigurasi lama..."
          rm -rf crosstool-ng crosstool-NG .config* x-tools overlays
          mkdir -p x-tools

      - name: Set environment variables
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV

      - name: Install dependencies build
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev \
            python3 python3-dev python3-distutils \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils unzip
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download dan setup crosstool-NG (Fork Espressif)
        run: |
          echo "Mengunduh crosstool-NG fork Espressif..."
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          echo "Fork Espressif $CROSSTOOL_NG_VERSION siap"

      - name: Build dan install crosstool-NG
        run: |
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local
          make -j$(nproc)
          sudo make install
          echo "crosstool-NG terinstall"

      - name: Pre-download SEMUA tarball yang diperlukan
        run: |
          echo "PRE-DOWNLOAD SEMUA TARBALL KE CACHE LOKAL..."
          mkdir -p crosstool-ng/.build/tarballs
          cd crosstool-ng/.build/tarballs
          
          wget -q --tries=3 --timeout=60 https://gcc.gnu.org/pub/gcc/infrastructure/isl-0.22.tar.xz && echo "✓ isl-0.22" || echo "✗ isl-0.22"
          wget -q --tries=3 --timeout=60 https://zlib.net/zlib-1.2.11.tar.xz && echo "✓ zlib-1.2.11" || echo "✗ zlib-1.2.11"
          wget -q --tries=3 --timeout=60 https://gmplib.org/download/gmp/gmp-6.2.0.tar.xz && echo "✓ gmp-6.2.0" || echo "✗ gmp-6.2.0"
          wget -q --tries=3 --timeout=60 https://www.mpfr.org/mpfr-4.0.2/mpfr-4.0.2.tar.xz && echo "✓ mpfr-4.0.2" || echo "✗ mpfr-4.0.2"
          wget -q --tries=3 --timeout=60 https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz && echo "✓ mpc-1.1.0" || echo "✗ mpc-1.1.0"
          
          echo "Tarball yang tersedia:"
          ls -la *.tar.* 2>/dev/null | wc -l

      - name: BUAT KONFIGURASI SEDERHANA TANPA COMPLEXITY
        run: |
          cd crosstool-ng
          
          echo "=== STRATEGI BARU: Minimal Configuration ==="
          echo "1. Reset total..."
          rm -f .config .config.old .config.bak
          
          echo "2. Gunakan ct-ng untuk pilih target..."
          ./ct-ng $TARGET 2>&1 | grep -v "deprecated\|warning" || true
          
          if [ ! -f .config ]; then
            echo "ct-ng $TARGET gagal, buat manual..."
            # PERBAIKAN: Ganti heredoc dengan echo
            echo "CT_EXPERIMENTAL=y" > .config
            echo "CT_ALLOW_BUILD_AS_ROOT=y" >> .config
            echo "CT_ALLOW_BUILD_AS_ROOT_SURE=y" >> .config
            echo "CT_LOG_PROGRESS_BAR=n" >> .config
            echo "CT_KERNEL_BARE_METAL=y" >> .config
            echo "CT_LIBC_NEWLIB=y" >> .config
            echo "CT_CC_LANG_CXX=y" >> .config
            echo "CT_DEBUG_GDB=y" >> .config
          fi
          
          echo "3. PAKSA SETEL TARGET dengan sed..."
          sed -i '/CT_TARGET/d' .config
          echo "CT_TARGET=\"$TARGET\"" >> .config
          
          echo "4. Setel arsitektur Xtensa..."
          if [[ "$TARGET" == "xtensa-"* ]]; then
            sed -i '/CT_ARCH/d' .config
            echo "CT_ARCH=\"xtensa\"" >> .config
            if [[ "$TARGET" == *"esp32"* ]]; then
              echo "CT_ARCH_XTENSA_CORE=\"${TARGET#xtensa-}\"" | sed 's/-elf//' >> .config
              echo "CT_ARCH_XTENSA_SYSTEM=\"lx6\"" >> .config
            fi
          fi
          
          echo "5. Setel host ARM64..."
          echo "CT_HOST=\"${CT_HOST_TRIPLET}\"" >> .config
          echo "CT_PREFIX_DIR=\"${CT_PREFIX_DIR}\"" >> .config
          echo "CT_LOCAL_TARBALLS_DIR=\"$GITHUB_WORKSPACE/crosstool-ng/.build/tarballs\"" >> .config
          
          echo "6. HAPUS SEMUA alphaev4 references..."
          grep -n "alphaev4" .config && echo "WARNING: Masih ada alphaev4!" || echo "✓ Tidak ada alphaev4"
          sed -i '/alphaev4/d' .config
          
          echo "7. Tampilkan konfigurasi final..."
          echo "=== CONFIG FINAL (10 baris pertama) ==="
          head -20 .config
          echo "CT_TARGET eksplisit: $(grep 'CT_TARGET=' .config)"

      - name: VALIDASI KONFIGURASI dengan ct-ng show-config
        run: |
          cd crosstool-ng
          echo "Validasi: ct-ng show-config"
          ./ct-ng show-config 2>&1 | head -30 || echo "show-config error, lanjut saja..."
          
          echo "Verifikasi target yang AKTIF:"
          ./ct-ng show-config 2>&1 | grep -i "target\|TARGET" || true

      - name: Build dengan CT_NG_BUILD_FORCE
        id: build
        run: |
          cd crosstool-ng
          export HOME=$GITHUB_WORKSPACE
          
          echo "=== BUILD DENGAN ENV VARIABLES ==="
          export CT_NG_BUILD_FORCE=1
          export CT_ISL_MIRROR="https://gcc.gnu.org/pub/gcc/infrastructure"
          export CT_ZLIB_MIRROR="https://zlib.net"
          export CT_GMP_MIRROR="https://gmplib.org/download/gmp"
          
          mkdir -p "${CT_PREFIX_DIR}"
          
          echo "Mulai build $TARGET..."
          echo "Menggunakan config:"
          grep "CT_TARGET\|CT_ARCH\|CT_HOST" .config || echo "Config tidak terbaca"
          
          set +e
          ./ct-ng build 2>&1 | tee build-full.log
          BUILD_STATUS=$?
          set -e
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "✓✓✓ BUILD SUKSES! ✓✓✓"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "✗✗✗ BUILD GAGAL ✗✗✗"
            
            echo "=== ERROR ANALYSIS ==="
            echo "1. Ada 'alphaev4' dalam log?"
            grep -i "alphaev4" build-full.log && echo "YA ADA!" || echo "TIDAK ADA"
            
            echo "2. Ada 'download failed'?"
            grep -i "download failed" build-full.log || echo "Bukan error download"
            
            echo "3. Target dalam config akhir?"
            echo "File .config akhir:"
            grep "CT_TARGET" .config || echo "CT_TARGET tidak ada"
            
            echo "4. 20 baris terakhir log:"
            tail -20 build-full.log
            
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verifikasi hasil build
        if: steps.build.outputs.success == 'true'
        id: package
        run: |
          echo "Memverifikasi toolchain $TARGET..."
          
          if [ -f "${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc" ]; then
            echo "✓✓✓ SUKSES: Toolchain $TARGET ADA! ✓✓✓"
            "${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc" --version | head -1
            
            mkdir -p artifacts
            ASSET="${TARGET}-host-arm64.tar.gz"
            tar -czf "artifacts/${ASSET}" -C "${CT_PREFIX_DIR}" "${TARGET}"
            
            echo "✓ Toolchain dipackage: $ASSET"
            echo "asset_name=${ASSET}" >> $GITHUB_OUTPUT
          else
            echo "✗ Toolchain TIDAK DITEMUKAN"
            echo "Isi ${CT_PREFIX_DIR}:"
            ls -la "${CT_PREFIX_DIR}" || true
            exit 1
          fi

      - name: Upload artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset_name || matrix.target }}-arm64
          path: |
            artifacts/
          retention-days: 7

      - name: Simpan log error untuk debugging
        if: steps.build.outputs.success == 'false'
        run: |
          echo "Menyimpan log error untuk analisis..."
          mkdir -p error-logs
          cp crosstool-ng/build-full.log error-logs/build-${{ matrix.target }}.log 2>/dev/null || true
          cp crosstool-ng/.config error-logs/config-${{ matrix.target }}.txt 2>/dev/null || true
          
          echo "Log error disimpan di error-logs/"
          ls -la error-logs/