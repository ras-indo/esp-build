name: ðŸ§  Viral Shorts â€” AI Brain (Core Fix)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Jumlah Klip'
        required: false
        default: '5'
      ai_creativity:
        description: 'Creativity (0.0 - 1.0)'
        required: false
        default: '0.7'

jobs:
  ai-editor-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Menginstall package inti yang pasti ada module-nya
          python -m pip install -q yt-dlp ffmpeg-python openai tiktoken
          python -m pip install -q langchain-core langchain-openai langchain-community
          python -m pip install -q git+https://github.com/openai/whisper.git

      - name: Create Intelligent Editor Script
        run: |
          cat > ai_editor.py << 'EOF'
          import os
          import json
          import subprocess
          import sys
          import whisper
          from pathlib import Path
          
          # --- FIXED IMPORTS (Using langchain_core) ---
          try:
              from langchain_openai import ChatOpenAI
              from langchain_core.prompts import ChatPromptTemplate
              from langchain_core.output_parsers import JsonOutputParser
          except ImportError as e:
              print(f"CRITICAL IMPORT ERROR: {e}")
              print("Pastikan langchain-core dan langchain-openai terinstall.")
              sys.exit(1)

          # === KONFIGURASI CUSTOM ===
          CUSTOM_API_KEY = "Kontolondon"
          CUSTOM_BASE_URL = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          TEMP = float(os.environ.get("AI_CREATIVITY", 0.7))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"

          # === 1. DOWNLOAD VIDEO ===
          def download_video():
              print(f"â¬‡ï¸ Downloading video...")
              subprocess.run(["yt-dlp", VIDEO_URL, "-o", str(VIDEO_PATH), "--force-overwrites"], stdout=subprocess.DEVNULL)
              if not VIDEO_PATH.exists() or VIDEO_PATH.stat().st_size < 1000:
                  print("ðŸ”„ Switch to Curl...")
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)])
              
              if VIDEO_PATH.exists():
                  print("âœ… Video ready.")
              else:
                  raise Exception("Gagal download video.")

          # === 2. WHISPER (PENDENGARAN) ===
          def transcribe_video():
              print("ðŸ‘‚ Menggunakan Whisper untuk mendengar...")
              model = whisper.load_model("small") 
              result = model.transcribe(str(VIDEO_PATH))
              return result["segments"]

          # === 3. LANGCHAIN BRAIN (OTAK EDITOR) ===
          def ai_editorial_decision(segments):
              print("ðŸ§  AI Editor sedang berpikir...")
              
              # Context Preparation
              transcript_context = ""
              for seg in segments:
                  start_t = int(seg['start'])
                  transcript_context += f"[{start_t}s] {seg['text']}\n"

              # Inisialisasi LLM
              llm = ChatOpenAI(
                  temperature=TEMP,
                  model="gpt-3.5-turbo",
                  openai_api_key=CUSTOM_API_KEY,
                  openai_api_base=CUSTOM_BASE_URL
              )

              # Definisi Prompt dengan Instruksi JSON manual (Lebih stabil daripada parser kompleks)
              template_string = """
              Kamu adalah Editor Video Profesional untuk TikTok/Shorts.
              Tugas: Analisis transkrip berikut dan pilih {num_clips} klip paling viral.
              
              KRITERIA:
              1. Hook kuat di awal.
              2. Cerita koheren (nyambung).
              3. Emosi: Lucu, Mengejutkan, Informatif, atau Sedih.
              4. Durasi: 15-60 detik.
              
              OUTPUT FORMAT (WAJIB JSON MURNI):
              Keluarkan JSON berisi list objek dengan kunci: "start_time", "end_time", "title", "reasoning", "emotion".
              Contoh:
              [
                {{
                  "start_time": 10,
                  "end_time": 40,
                  "title": "Judul Menarik",
                  "reasoning": "Lucu banget",
                  "emotion": "Funny"
                }}
              ]

              TRANSKRIP:
              {transcript}
              """

              prompt = ChatPromptTemplate.from_template(template_string)
              
              # Batasi panjang transkrip
              transcript_slice = transcript_context[:14000] 
              
              messages = prompt.format_messages(
                  num_clips=NUM_CLIPS,
                  transcript=transcript_slice
              )
              
              # Gunakan JsonOutputParser untuk membersihkan output LLM
              parser = JsonOutputParser()

              try:
                  response = llm.invoke(messages)
                  print("âœ… Keputusan AI diterima.")
                  
                  # Parse hasil
                  parsed_data = parser.parse(response.content)
                  
                  # JsonOutputParser kadang mereturn dict jika cuma 1 item, kita butuh list
                  if isinstance(parsed_data, dict):
                      # Cek apakah dibungkus key tertentu
                      if "clips" in parsed_data:
                          return parsed_data["clips"]
                      return [parsed_data]
                  elif isinstance(parsed_data, list):
                      return parsed_data
                  else:
                      return []
                      
              except Exception as e:
                  print(f"âŒ Error saat AI berpikir: {e}")
                  if 'response' in locals():
                      print("Raw response:", response.content)
                  return []

          # === 4. FFMPEG (TANGAN EDITOR) ===
          def cut_and_save(clips_data):
              print("âœ‚ï¸ Memotong video...")
              
              for idx, clip in enumerate(clips_data):
                  try:
                      start = float(clip["start_time"])
                      end = float(clip["end_time"])
                      duration = end - start
                      
                      if duration < 3: continue 

                      filename = f"short_{idx+1:02d}.mp4"
                      out_path = OUTDIR / filename
                      json_path = OUTDIR / f"short_{idx+1:02d}_meta.json"

                      cmd = [
                          "ffmpeg", "-y",
                          "-ss", str(start),
                          "-i", str(VIDEO_PATH),
                          "-t", str(duration),
                          "-c:v", "libx264", "-c:a", "aac", 
                          "-preset", "fast",
                          str(out_path)
                      ]
                      subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

                      metadata = {
                          "filename": filename,
                          "title": clip.get("title", "Untitled"),
                          "reasoning": clip.get("reasoning", ""),
                          "emotion": clip.get("emotion", "neutral"),
                          "timing": {"start": start, "end": end}
                      }
                      
                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(metadata, f, indent=2, ensure_ascii=False)
                      
                      print(f"ðŸ‘‰ Exported: {filename} ({clip.get('title')})")
                  except Exception as ex:
                      print(f"Gagal klip {idx}: {ex}")

          # === MAIN ===
          if __name__ == "__main__":
              try:
                  download_video()
                  raw_segments = transcribe_video()
                  
                  if len(raw_segments) == 0:
                      print("âš ï¸ Transkrip kosong.")
                      sys.exit(0)

                  selected_clips = ai_editorial_decision(raw_segments)
                  
                  if selected_clips:
                      cut_and_save(selected_clips)
                  else:
                      print("âš ï¸ AI tidak menemukan klip yang cocok.")
                      
              except Exception as e:
                  print(f"âŒ Critical Error: {e}")
                  sys.exit(1)
          EOF

      - name: Run Pipeline
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
          AI_CREATIVITY: ${{ github.event.inputs.ai_creativity }}
        run: python ai_editor.py

      - name: Zip Results
        run: zip -r viral_shorts_pack.zip output

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Custom-Result
          path: viral_shorts_pack.zip
