
name: Build ESP-IDF Native Android (Alpine Static) - FINAL

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'

jobs:
  build-native-static:
    # Menggunakan runner ARM64 native
    runs-on: ubuntu-22.04-arm
    
    # Menjalankan job di dalam Container Alpine Linux (Musl Libc)
    # Kita gunakan versi 3.17 agar kompatibel dengan source code GCC 8.4
    container:
      image: alpine:3.17
      options: --privileged

    timeout-minutes: 360

    steps:
      - name: 1. Install Dependencies Alpine
        run: |
          echo "Installing build dependencies..."
          apk update
          
          # Install toolchain dasar dan library static
          apk add --no-cache \
            build-base git bash autoconf automake bison flex texinfo \
            gawk libtool ncurses-dev ncurses-static python3-dev \
            unzip wget bzip2 xz help2man file rsync patch \
            expat-dev expat-static zlib-dev zlib-static \
            linux-headers gettext-dev gettext-static libiconv-dev

          # Pastikan python mengarah ke python3
          ln -sf /usr/bin/python3 /usr/bin/python
          
          # Cek versi gcc host
          gcc --version

      - name: 2. Checkout & Setup Workspace
        uses: actions/checkout@v4
      
      - name: 3. Setup Permissions & Directories
        run: |
          # Fix permission error "dubious ownership" di git
          git config --global --add safe.directory '*'
          
          # Buat struktur folder
          mkdir -p x-tools artifacts .build/tarballs
          
          # Simpan path root ke ENV agar konsisten
          echo "ROOT_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: 4. Download crosstool-NG
        run: |
          cd $ROOT_DIR
          echo "Cloning crosstool-NG branch: $CROSSTOOL_NG_VERSION"
          git clone https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          
          cd crosstool-NG
          git submodule update --init --recursive
          
          # Install crosstool-ng
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          make install

      - name: 5. Download Library Manual (ISL Fix)
        run: |
          # Download ISL library manual karena server sering down
          mkdir -p $ROOT_DIR/.build/tarballs
          cd $ROOT_DIR/.build/tarballs
          
          echo "Downloading ISL 0.19..."
          wget --tries=5 --waitretry=5 -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2 || \
          wget --tries=5 -O isl-0.19.tar.bz2 https://libisl.sourceforge.io/isl-0.19.tar.bz2

      - name: 6. Konfigurasi Toolchain (Alpine/Musl Static)
        run: |
          cd $ROOT_DIR/crosstool-NG
          
          TARGET="xtensa-esp32-elf"
          
          # Generate config awal
          ./ct-ng $TARGET
          
          # Bersihkan setting path hardcoded dari sample
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_LOG_PROGRESS_BAR/d' .config
          sed -i '/CT_STATIC_TOOLCHAIN/d' .config
          
          # INJECT CONFIGURASI KHUSUS ALPINE STATIC
          cat >> .config <<EOF
          
          # --- PATHS ---
          CT_PREFIX_DIR="${ROOT_DIR}/x-tools/${TARGET}"
          CT_LOCAL_TARBALLS_DIR="${ROOT_DIR}/.build/tarballs"
          
          # --- BUILD ENVIRONMENT ---
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_EXPERIMENTAL=y
          CT_LOG_PROGRESS_BAR=n
          CT_PARALLEL_JOBS=$(nproc)
          
          # --- TARGET DEFINITION ---
          CT_ARCH="xtensa"
          CT_TARGET_VENDOR="esp32"
          CT_ARCH_XTENSA_CORE="esp32"
          CT_OVERLAY_NAME="esp32"
          CT_OVERLAY_LOCATION="${ROOT_DIR}/crosstool-NG/overlays"
          
          # --- STATIC LINKING (MUSL) ---
          # Ini bagian paling penting agar jalan di Android native
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_CC_CX_LDFLAGS="-static"
          
          # Strip binary agar tidak terlalu besar
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y
          
          # --- GDB (NO PYTHON) ---
          # Python static build hampir mustahil stabil
          CT_GDB_CROSS_PYTHON=n
          CT_GDB_CROSS_PYTHON_BINARY=""
          
          EOF
          
          # Fix Kernel (Set none agar tidak bergantung versi kernel host)
          if grep -q "CT_KERNEL" .config; then
             sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config
          else
             echo 'CT_KERNEL="none"' >> .config
          fi

          # Update config
          yes "" | ./ct-ng oldconfig

      - name: 7. Build Toolchain
        id: build
        run: |
          cd $ROOT_DIR/crosstool-NG
          
          # Set permission environment variable lagi untuk memastikan
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          echo "Starting Build Process... This may take 60+ minutes."
          ./ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: 8. Verifikasi & Packaging
        if: steps.build.outputs.success == 'true'
        run: |
          TARGET="xtensa-esp32-elf"
          BIN_DIR="$ROOT_DIR/x-tools/$TARGET/bin"
          
          echo "=== VERIFIKASI BINARY ==="
          ls -l $BIN_DIR/xtensa-esp32-elf-gcc
          
          # Cek tipe file (Harus: statically linked)
          FILE_TYPE=$(file $BIN_DIR/xtensa-esp32-elf-gcc)
          echo "File Type: $FILE_TYPE"
          
          if [[ "$FILE_TYPE" != *"statically linked"* ]]; then
             echo "WARNING: Binary sepertinya tidak static!"
          else
             echo "SUCCESS: Binary adalah STATICALLY LINKED (Support Android Native)"
          fi
          
          # Packaging
          ARTIFACT_NAME="${TARGET}-gcc8_4_0-musl-static-android.tar.gz"
          cd "$ROOT_DIR/x-tools"
          
          # Gunakan tar biasa (Alpine tar aman untuk ini)
          tar -czf "$ROOT_DIR/artifacts/$ARTIFACT_NAME" $TARGET
          
          echo "ARTIFACT_PATH=$ROOT_DIR/artifacts/$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: 9. Upload Artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: xtensa-esp32-elf-android-native
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30

      - name: 10. Upload Logs (Jika Gagal)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: ${{ env.ROOT_DIR }}/crosstool-NG/build.log
          retention-days: 5
