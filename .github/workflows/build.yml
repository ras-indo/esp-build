name: Build ESP32-S3 and Public Auto-Release

on:
  push:
    branches: [ main, master ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout kode + submodul
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup ESP-IDF dan Build (ESP32-S3)
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: 'v5.1'
        target: 'esp32s3'
        path: '.'

    - name: Kemas file BIN untuk flashing
      id: zip-bin
      run: |
        mkdir flash_package

        # Salin file penting hasil build
        cp build/bootloader/bootloader.bin flash_package/
        cp build/partition_table/partition-table.bin flash_package/
        cp build/*.bin flash_package/ || true
        cp build/flasher_args.json flash_package/ || true

        # README singkat untuk user
        cat << EOF > flash_package/README_FLASH.txt
        ESP32-S3 Flash Package

        Contoh flashing:
        esptool.py --chip esp32s3 -p PORT -b 460800 \\
          --before default_reset --after hard_reset write_flash \\
          0x0 bootloader.bin \\
          0x8000 partition-table.bin \\
          0x10000 *.bin

        EOF

        TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
        ZIP_NAME="esp32s3-firmware-$TIMESTAMP.zip"
        zip -r $ZIP_NAME flash_package

        echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

    - name: Buat / Update Rilis Publik
      uses: softprops/action-gh-release@v1
      with:
        tag_name: latest
        name: ESP32-S3 Latest Build
        body: |
          Build otomatis ESP32-S3

          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          ZIP berisi file BIN siap flash ke ESP32-S3.
        draft: false
        prerelease: true
        replace: true
        remove_assets: true
        files: ${{ steps.zip-bin.outputs.zip_name }}

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
