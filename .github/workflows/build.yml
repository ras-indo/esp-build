name: Build ESP-IDF Toolchains (ARM64 Host) - Auto

on:
  push:
    branches:
      - 'main'
      - 'releases/**'

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - xtensa-lx106-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV

      - name: Cache toolchains and ct-ng cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CT_PREFIX_DIR }}
            ~/.cache/ct-ng
          key: arm64-ctng-${{ matrix.target }}-${{ env.CROSSTOOL_NG_VERSION }}-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Install build dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev \
            python3 python3-dev python3-distutils \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download and setup crosstool-NG (Espressif Fork)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          echo "Using Espressif fork ($CROSSTOOL_NG_VERSION) for ESP targets"

      - name: Build and install crosstool-NG
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local
          make -j$(nproc)
          sudo make install

      - name: Download ESP-IDF toolchain configuration
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p esp-configs
          # Download konfigurasi dari ESP-IDF repository
          # Untuk target Xtensa (ESP32, ESP32-S2, ESP32-S3, ESP8266)
          if [[ "$TARGET" == xtensa-* ]]; then
            CONFIG_URL="https://raw.githubusercontent.com/espressif/esp-idf/master/tools/toolchain/$TARGET/crosstool.config"
          # Untuk target RISC-V (ESP32-C3, ESP32-C6)
          elif [[ "$TARGET" == riscv32-* ]]; then
            CONFIG_URL="https://raw.githubusercontent.com/espressif/esp-idf/master/tools/toolchain/$TARGET/crosstool.config"
          fi
          
          echo "Downloading config from: $CONFIG_URL"
          if wget -q --spider "$CONFIG_URL"; then
            wget -q -O esp-configs/$TARGET.config "$CONFIG_URL"
            echo "Config downloaded successfully"
          else
            echo "WARNING: Config not found at $CONFIG_URL"
            # Gunakan config dasar - TIDAK PAKAI HEREDOC
            echo "CT_EXPERIMENTAL=y" > esp-configs/$TARGET.config
            echo "CT_ALLOW_BUILD_AS_ROOT=y" >> esp-configs/$TARGET.config
            echo "CT_ALLOW_BUILD_AS_ROOT_SURE=y" >> esp-configs/$TARGET.config
            echo "CT_LOG_PROGRESS_BAR=n" >> esp-configs/$TARGET.config
            echo "CT_LOG_LEVEL_MAX=INFO" >> esp-configs/$TARGET.config
          fi

      - name: Prepare configuration for ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          
          # Gunakan config dari ESP-IDF jika ada
          if [ -f "$GITHUB_WORKSPACE/esp-configs/$TARGET.config" ]; then
            echo "Using ESP-IDF configuration for $TARGET"
            cp "$GITHUB_WORKSPACE/esp-configs/$TARGET.config" .config
          else
            echo "ERROR: No configuration found for $TARGET"
            exit 1
          fi
          
          # Tentukan CT_ARCH berdasarkan target
          if [[ "$TARGET" == xtensa-* ]]; then
            echo "CT_ARCH=\"xtensa\"" >> .config
            echo "CT_ARCH_XTENSA_CORE=\"$(echo $TARGET | sed 's/xtensa-\(.*\)-elf/\1/')-lite\"" >> .config
          elif [[ "$TARGET" == riscv32-* ]]; then
            echo "CT_ARCH=\"riscv\"" >> .config
            echo "CT_ARCH_RISCV_ARCH=\"rv32imafc\"" >> .config
            echo "CT_ARCH_RISCV_ABI=\"ilp32f\"" >> .config
          fi
          
          # Pengaturan wajib untuk build sukses
          echo "CT_TARGET=\"$TARGET\"" >> .config
          echo "CT_PREFIX_DIR=\"${CT_PREFIX_DIR}\"" >> .config
          echo "CT_HOST=\"${CT_HOST_TRIPLET}\"" >> .config
          echo "CT_KERNEL_BARE_METAL=y" >> .config
          echo "CT_LIBC_NEWLIB=y" >> .config
          echo "CT_CC_LANG_CXX=y" >> .config
          echo "CT_CC_GCC_EXTRA_CONFIG_ARRAY=\"\"" >> .config
          echo "CT_BINUTILS_EXTRA_CONFIG_ARRAY=\"\"" >> .config
          echo "CT_ARCH_ARCH=\"\"" >> .config
          echo "CT_ARCH_TUNE=\"\"" >> .config
          echo "CT_ARCH_CPU=\"\"" >> .config
          
          # Hapus duplikasi dan blank lines
          sort -u .config -o .config
          sed -i '/^$/d' .config
          
          # Validasi konfigurasi
          echo "Validating configuration..."
          if ! ./ct-ng show-config > /dev/null 2>&1; then
            echo "ERROR: Configuration validation failed"
            echo "First 50 lines of config:"
            head -50 .config
            exit 1
          fi
          
          cp .config "$GITHUB_WORKSPACE/.config-$TARGET-final"
          echo "Final configuration saved"

      - name: Build toolchain ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          export HOME=$GITHUB_WORKSPACE
          
          # Buat direktori output
          mkdir -p "${CT_PREFIX_DIR}"
          
          echo "Building $TARGET..."
          
          # Tampilkan info konfigurasi penting
          echo "Important config values:"
          grep -E "CT_ARCH|CT_TARGET|CT_HOST|CT_PREFIX_DIR" .config || true
          
          # Build dengan verbose output untuk debugging
          ./ct-ng build 2>&1 | tee build.log
          
          # Cek status build
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "Build $TARGET successful!"
          else
            echo "Build $TARGET failed. Last 100 lines of log:"
            tail -100 build.log
            exit 1
          fi

      - name: Verify and package toolchain
        id: package
        run: |
          # Verifikasi toolchain
          TOOLCHAIN_BIN="${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc"
          if [ -f "$TOOLCHAIN_BIN" ]; then
            echo "Toolchain $TARGET built successfully"
            "$TOOLCHAIN_BIN" --version | head -1
            
            # Test compile sederhana
            echo 'int main() { return 0; }' > test.c
            "$TOOLCHAIN_BIN" -o test.elf test.c
            if [ -f "test.elf" ]; then
              echo "Test compilation successful"
              rm test.c test.elf
            fi
          else
            echo "ERROR: Toolchain not found at $TOOLCHAIN_BIN"
            echo "Checking directory contents..."
            find "${CT_PREFIX_DIR}" -type f -name "*gcc*" 2>/dev/null || true
            exit 1
          fi
          
          # Package toolchain
          mkdir -p artifacts
          ASSET="${TARGET}-host-arm64.tar.gz"
          tar -czf "artifacts/${ASSET}" -C "${CT_PREFIX_DIR}" "${TARGET}"
          sha256sum "artifacts/${ASSET}" > "artifacts/${ASSET}.sha256"
          echo "asset_name=${ASSET}" >> $GITHUB_OUTPUT
          echo "asset_path=artifacts/${ASSET}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset_name }}
          path: |
            artifacts/
          retention-days: 30

  summary:
    needs: compile
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# Build Summary" > summary.md
          echo "Completed at: $(date)" >> summary.md
          echo "Workflow: ${{ github.workflow }}" >> summary.md
          echo "## Targets built:" >> summary.md
          echo "- xtensa-esp32-elf" >> summary.md
          echo "- xtensa-esp32s2-elf" >> summary.md
          echo "- xtensa-esp32s3-elf" >> summary.md
          echo "- xtensa-lx106-elf" >> summary.md
          echo "- riscv32-esp-elf" >> summary.md
          cat summary.md
