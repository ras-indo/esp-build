
name: Build ESP-IDF Toolchain (Alpine/Musl Static) - ANDROID NATIVE

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  # Kita tidak butuh set CT_HOST_TRIPLET manual, karena build di Alpine otomatis jadi Musl
  
jobs:
  compile-alpine:
    # Kita tetap pakai runner ARM, tapi jalan di dalam container Alpine
    runs-on: ubuntu-22.04-arm
    
    # MAGIC: Jalankan semua proses di dalam Alpine Linux
    container:
      image: alpine:3.15
      options: --privileged

    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Install Dependencies (Alpine)
        run: |
          echo "Installing Alpine Dependencies..."
          # Install paket dasar untuk build crosstool-ng
          apk update
          apk add --no-cache \
            build-base git bash bison flex texinfo gawk help2man \
            libtool ncurses-dev python3 python3-dev unzip wget \
            xz automake autoconf shadow file patch \
            linux-headers gettext-dev

          # Link python3 ke python
          ln -sf /usr/bin/python3 /usr/bin/python

      - name: Setup User (Non-Root)
        run: |
          # Crosstool-NG sebaiknya tidak dibuild sebagai root, kita buat user 'builder'
          useradd -m -s /bin/bash builder
          mkdir -p /github/workspace
          chown -R builder:builder /github/workspace
          chown -R builder:builder /__w || true

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Prepare Workspace
        run: |
          mv repo/* .
          rm -rf crosstool-ng .build x-tools artifacts
          mkdir -p x-tools artifacts
          chown -R builder:builder .

      - name: Download & Install crosstool-NG
        # Kita jalankan sebagai user builder
        shell: su builder {0}
        run: |
          echo "Mengunduh crosstool-NG branch: $CROSSTOOL_NG_VERSION"
          git clone https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          
          cd crosstool-ng
          echo "=== INIT SUBMODULES ==="
          git submodule update --init --recursive
          
          # Fix untuk Alpine: Kadang butuh touch file agar timestamp benar
          find . -name configure.ac -exec touch {} +
          
          ./bootstrap
          ./configure --enable-local --prefix=$PWD/install
          make -j$(nproc)
          make install

      - name: Siapkan Config & Patch
        shell: su builder {0}
        env:
          TARGET: ${{ matrix.target }}
        run: |
          export PATH=$PWD/crosstool-ng/install/bin:$PATH
          mkdir -p .build/tarballs
          
          cd crosstool-ng
          
          # 1. Generate Config Awal
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            cp samples/$TARGET/crosstool.config .config
          else
            ct-ng $TARGET
          fi

          # 2. Bersihkan Config Lama
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_LogFile/d' .config
          
          # 3. Inject Config BARU (MUSL STATIC)
          # Perhatikan: Kita matikan Werror karena compiler Alpine lebih strict
          cat >> .config <<EOF
          
          # Paths
          CT_PREFIX_DIR="$GITHUB_WORKSPACE/x-tools/${TARGET}"
          CT_LOCAL_TARBALLS_DIR="$GITHUB_WORKSPACE/.build/tarballs"
          
          # Build Options
          CT_PARALLEL_JOBS=$(nproc)
          CT_LOG_PROGRESS_BAR=n
          CT_Experimental=y
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          # --- KUNCI KEBERHASILAN DI TERMUX ---
          # 1. Static Linking
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          # 2. Strip binary
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y
          # 3. Matikan Python GDB (Penyebab error di static build)
          CT_GDB_CROSS_PYTHON=n
          CT_GDB_CROSS_PYTHON_BINARY=""
          # 4. Matikan Warning as Error (Penting di Alpine)
          CT_WERROR=n
          # ------------------------------------
          
          # ESP32 Specifics
          CT_TARGET_VENDOR="esp32"
          CT_OVERLAY_NAME="esp32"
          CT_OVERLAY_LOCATION="$GITHUB_WORKSPACE/crosstool-ng/overlays"
          EOF
          
          # Fix Kernel Version check
          sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config

          # Update config
          yes "" | ct-ng oldconfig

      - name: Build Toolchain
        shell: su builder {0}
        id: build
        run: |
          export PATH=$PWD/crosstool-ng/install/bin:$PATH
          cd crosstool-ng
          
          # Fix ISL download manual (Alpine kadang fail SSL lama)
          cd ../.build/tarballs
          wget --no-check-certificate -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2 || true
          cd ../../crosstool-ng
          
          echo "Memulai Build di Alpine (Musl)..."
          ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Packaging
        if: steps.build.outputs.success == 'true'
        run: |
          echo "Checking binary type..."
          # Verifikasi bahwa ini benar-benar static
          file x-tools/${{ matrix.target }}/bin/*-gcc | head -n 1
          
          ARTIFACT_NAME="${{ matrix.target }}-gcc8_4_0-musl-static-native-android.tar.gz"
          
          cd x-tools
          # Tar tanpa owner info agar tidak masalah permission saat extract
          tar --owner=0 --group=0 -czf ../artifacts/$ARTIFACT_NAME *
          
          echo "ARTIFACT_PATH=$GITHUB_WORKSPACE/artifacts/$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-android-native
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30

      - name: Upload Logs (If Fail)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: crosstool-ng/build.log
