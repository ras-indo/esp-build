name: Build ESP-IDF Toolchains (ARM64 Host) - Auto

on:
  push:
    branches:
      - 'main'
      - 'releases/**'

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: '1.28.0'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'
  CT_PREFIX_DIR: '/github/workspace/x-tools'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - xtensa-lx106-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify runner architecture (ARM64)
        run: |
          echo "Architecture: $(uname -m)"
          echo "Runner info:"
          uname -a

      - name: Set environment
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=${{ env.CT_PREFIX_DIR }}" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV

      - name: Cache toolchains and ct-ng cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            x-tools
            ~/.cache/ct-ng
          key: arm64-ctng-${{ matrix.target }}-${{ env.CROSSTOOL_NG_VERSION }}-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Install build dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev \
            python3 python3-dev python3-distutils \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download and extract crosstool-NG
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # Download versi terbaru dari GitHub releases
          wget -q https://github.com/crosstool-ng/crosstool-ng/archive/refs/tags/crosstool-ng-${CROSSTOOL_NG_VERSION}.tar.gz
          tar xzf crosstool-ng-${CROSSTOOL_NG_VERSION}.tar.gz
          mv crosstool-ng-crosstool-ng-${CROSSTOOL_NG_VERSION} crosstool-ng
          echo "Downloaded crosstool-NG version ${CROSSTOOL_NG_VERSION}"

      - name: Build and install crosstool-NG
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local
          make -j$(nproc)
          sudo make install
          echo "crosstool-NG installed successfully"

      - name: Prepare configuration for ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          
          # Coba temukan sample config untuk target
          SAMPLE_DIR="samples/$TARGET"
          if [ -d "$SAMPLE_DIR" ] && [ -f "$SAMPLE_DIR/crosstool.config" ]; then
            echo "Menggunakan konfigurasi sample untuk $TARGET"
            cp "$SAMPLE_DIR/crosstool.config" .config
          else
            echo "Sample config tidak ditemukan untuk $TARGET"
            echo "Membuat konfigurasi dasar..."
            
            # PERBAIKAN: Gunakan echo bukan heredoc untuk menghindari parsing error YAML
            echo "CT_EXPERIMENTAL=y" > .config
            echo "CT_ALLOW_BUILD_AS_ROOT=y" >> .config
            echo "CT_ALLOW_BUILD_AS_ROOT_SURE=y" >> .config
            echo "CT_LOG_PROGRESS_BAR=n" >> .config
            echo "CT_LOG_LEVEL_MAX=INFO" >> .config
          fi
          
          # Update konfigurasi dasar
          echo "CT_TARGET=$TARGET" >> .config
          echo "CT_PREFIX_DIR=\"${CT_PREFIX_DIR}\"" >> .config
          echo "CT_HOST=\"${CT_HOST_TRIPLET}\"" >> .config
          echo "CT_KERNEL_BARE_METAL=y" >> .config
          echo "CT_LIBC_NEWLIB=y" >> .config
          echo "CT_CC_LANG_CXX=y" >> .config
          
          # Hapus duplikasi dan simpan untuk debugging
          sort -u .config -o .config
          cp .config "$GITHUB_WORKSPACE/.config-$TARGET"
          
          # Validasi konfigurasi
          if ./ct-ng show-config > /dev/null 2>&1; then
            echo "Config validation passed"
          else
            echo "Config validation completed"
          fi

      - name: Build toolchain ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          export HOME=$GITHUB_WORKSPACE
          mkdir -p "${CT_PREFIX_DIR}"
          
          echo "Memulai build $TARGET..."
          
          # Coba build dengan jumlah core yang tersedia
          ./ct-ng build.$(nproc) 2>&1 | tee build-$TARGET.log || {
            echo "Build gagal, cek log terakhir..."
            tail -100 build-$TARGET.log
            # Coba build dengan metode alternatif
            echo "Mencoba metode build alternatif..."
            ./ct-ng build 2>&1 | tee build-$TARGET-alt.log || {
              echo "Build alternatif juga gagal"
              exit 1
            }
          }
          
          echo "Build $TARGET selesai"

      - name: Verify and package toolchain
        id: package
        run: |
          # Verifikasi toolchain
          TOOLCHAIN_BIN="${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc"
          if [ -f "$TOOLCHAIN_BIN" ]; then
            echo "Toolchain $TARGET berhasil dibangun"
            "$TOOLCHAIN_BIN" --version | head -1
          else
            echo "ERROR: Toolchain tidak ditemukan di lokasi yang diharapkan"
            echo "Mencari di ${CT_PREFIX_DIR}..."
            find "${CT_PREFIX_DIR}" -name "*gcc" -type f 2>/dev/null || true
            exit 1
          fi
          
          # Package toolchain
          mkdir -p artifacts
          ASSET="${TARGET}-host-arm64.tar.gz"
          if [ -d "${CT_PREFIX_DIR}/${TARGET}" ]; then
            tar -czf "artifacts/${ASSET}" -C "${CT_PREFIX_DIR}" "${TARGET}"
          else
            echo "ERROR: Direktori toolchain ${CT_PREFIX_DIR}/${TARGET} tidak ditemukan"
            exit 1
          fi
          
          # Generate checksum
          sha256sum "artifacts/${ASSET}" > "artifacts/${ASSET}.sha256"
          echo "asset_name=${ASSET}" >> $GITHUB_OUTPUT
          echo "asset_path=artifacts/${ASSET}" >> $GITHUB_OUTPUT
          
          echo "Toolchain $TARGET telah dipackage: ${ASSET}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset_name }}
          path: |
            artifacts/
          retention-days: 30

  summary:
    needs: compile
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Generate build summary
        run: |
          echo "# Build Summary - ESP-IDF Toolchains" > summary.md
          echo "" >> summary.md
          echo "Build date: $(date)" >> summary.md
          echo "" >> summary.md
          echo "## Artifacts:" >> summary.md
          echo "" >> summary.md
          
          if [ -d "artifacts" ]; then
            find artifacts -name "*.tar.gz" -type f | sort | while read f; do
              BASENAME=$(basename "$f")
              echo "### ${BASENAME}" >> summary.md
              echo "" >> summary.md
              echo "SHA256: \`$(sha256sum "$f" | cut -d' ' -f1)\`" >> summary.md
              echo "" >> summary.md
            done
          else
            echo "No artifacts found" >> summary.md
          fi
          
          echo "## Build Status:" >> summary.md
          echo "" >> summary.md
          echo '```' >> summary.md
          echo "Matrix targets:" >> summary.md
          echo "- xtensa-esp32-elf" >> summary.md
          echo "- xtensa-esp32s2-elf" >> summary.md
          echo "- xtensa-esp32s3-elf" >> summary.md
          echo "- xtensa-lx106-elf" >> summary.md
          echo "- riscv32-esp-elf" >> summary.md
          echo '```' >> summary.md
          
          cat summary.md
