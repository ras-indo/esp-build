name: ðŸŽ¬ AI Director â€” Named Files & Deep Meta

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Target Jumlah Klip'
        required: false
        default: '5'

jobs:
  director-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Studio
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Install AI Libraries
        run: |
          python -m pip install --upgrade pip
          python -m pip install -q torch numpy
          python -m pip install -q yt-dlp ffmpeg-python tiktoken
          python -m pip install -q langchain-core langchain-openai langchain-community
          python -m pip install -q git+https://github.com/openai/whisper.git

      - name: Run Director Script
        run: |
          cat > ai_director.py << 'EOF'
          import os
          import sys
          import json
          import re
          import subprocess
          import gc
          import torch
          import whisper
          from pathlib import Path

          # --- LANGCHAIN ---
          try:
              from langchain_openai import ChatOpenAI
              from langchain_core.prompts import ChatPromptTemplate
              from langchain_core.output_parsers import JsonOutputParser
          except ImportError:
              sys.exit("Critical: LangChain modules not found.")

          # === CONFIGURATION ===
          API_KEY = "Kontolondon"
          API_BASE = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"

          # === 1. HARDWARE CHECK ===
          def get_device():
              if torch.cuda.is_available():
                  print(f"ðŸ–¥ï¸  GPU MODE: {torch.cuda.get_device_name(0)}")
                  return "cuda"
              print("ðŸ–¥ï¸  CPU MODE (Standard)")
              return "cpu"

          DEVICE = get_device()

          # === 2. DOWNLOAD ===
          def download_source():
              print("â¬‡ï¸  Fetching Video...")
              subprocess.run(["yt-dlp", VIDEO_URL, "-o", str(VIDEO_PATH), "--force-overwrites"], stdout=subprocess.DEVNULL)
              if not VIDEO_PATH.exists() or VIDEO_PATH.stat().st_size < 1000:
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)])
              if not VIDEO_PATH.exists(): raise Exception("Download Failed")
              print("âœ… Video Acquired.")

          # === 3. WHISPER (EARS) ===
          def listen_to_video():
              print("ðŸ‘‚ Whisper Medium (Listening)...")
              try:
                  model = whisper.load_model("medium", device=DEVICE)
                  result = model.transcribe(str(VIDEO_PATH), fp16=(DEVICE=="cuda"), verbose=False)
                  
                  # RAM CLEANUP
                  del model
                  gc.collect()
                  if DEVICE == "cuda": torch.cuda.empty_cache()
                  
                  return result["segments"]
              except Exception as e:
                  print(f"âŒ Audio Error: {e}")
                  sys.exit(1)

          # === 4. THE AI DIRECTOR (ADVISOR + EDITOR) ===
          def director_decision(segments):
              print("ðŸ§  AI Director & Advisor are conferring...")
              
              full_text = ""
              for s in segments:
                  full_text += f"[{int(s['start'])}s] {s['text']}\n"

              llm = ChatOpenAI(
                  model="gpt-4",
                  temperature=0.2, # Sedikit kreativitas untuk caption, tapi strict untuk timestamp
                  openai_api_key=API_KEY,
                  openai_api_base=API_BASE
              )
              
              parser = JsonOutputParser()

              # PROMPT YANG SANGAT DETAIL
              template = """
              Anda adalah TIM PRODUKSI VIDEO yang terdiri dari dua persona:
              1. **THE ADVISOR (Penasihat Viral)**: Ahli algoritma TikTok/Reels yang mengerti psikologi penonton.
              2. **THE EDITOR (Eksekutor)**: Editor presisi yang memotong video tanpa cacat.

              TUGAS:
              Analisis transkrip dan hasilkan {num_clips} klip video pendek terbaik.

              INSTRUKSI PENASIHAT:
              - Cari "Hook" (kalimat pembuka yang memancing rasa ingin tahu).
              - Cari emosi (Marah, Tawa, Fakta Mengejutkan).
              - Hindari bagian membosankan ("Halo guys", "Intro", "Loading").
              
              INSTRUKSI EDITOR:
              - Timestamp harus akurat.
              - Judul harus Clickbait tapi relevan.
              - Buat Caption Sosmed yang siap posting.

              OUTPUT WAJIB JSON (List of Objects):
              [
                {{
                  "start_time": 10.5,
                  "end_time": 40.0,
                  "title": "Judul Viral (Tanpa Emoji)",
                  "filename_suggestion": "Judul_Viral_Tanpa_Spasi",
                  "viral_analysis": {{
                      "hook_score": 95,
                      "pacing": "Cepat",
                      "emotion": "Lucu/Tegang/Informatif",
                      "advisor_notes": "Alasan penasihat memilih bagian ini..."
                  }},
                  "social_media": {{
                      "caption": "Caption menarik untuk diposting...",
                      "hashtags": ["#fyp", "#viral", "#tag3"]
                  }},
                  "transcript_snippet": "Teks transkrip di bagian ini..."
                }}
              ]

              TRANSKRIP SUMBER:
              {transcript}
              """

              prompt = ChatPromptTemplate.from_template(template)
              
              # Batasi konteks
              msgs = prompt.format_messages(num_clips=NUM_CLIPS, transcript=full_text[:18000])

              try:
                  res = llm.invoke(msgs)
                  print("âœ… Keputusan Direksi Diterima.")
                  data = parser.parse(res.content)
                  
                  if isinstance(data, dict): return [data]
                  return data
              except Exception as e:
                  print(f"âŒ Brain Failure: {e}")
                  # Fallback basic parsing jika AI ngoceh
                  try:
                      content = res.content.replace("```json", "").replace("```", "").strip()
                      return json.loads(content)
                  except:
                      return []

          # === 5. EXPORT & NAMING ===
          def sanitize_name(name):
              # Hanya izinkan huruf, angka, dan underscore
              clean = re.sub(r'[^a-zA-Z0-9]', '_', name)
              # Hapus underscore berlebih
              clean = re.sub(r'_+', '_', clean)
              return clean.strip('_')

          def production(clips):
              print("âœ‚ï¸  Produksi Dimulai...")
              
              for clip in clips:
                  try:
                      s = float(clip["start_time"])
                      e = float(clip["end_time"])
                      dur = e - s
                      
                      if dur < 5: continue

                      # Naming Logic
                      raw_title = clip.get("title", "Untitled")
                      safe_name = sanitize_name(raw_title)
                      
                      # Jika kosong, fallback ke ID
                      if len(safe_name) < 3: safe_name = f"Viral_Clip_{int(s)}"
                      
                      vid_fname = f"{safe_name}.mp4"
                      json_fname = f"{safe_name}.json"
                      
                      vid_path = OUTDIR / vid_fname
                      json_path = OUTDIR / json_fname

                      # FFMPEG Cutting
                      cmd = [
                          "ffmpeg", "-y", "-ss", str(s), "-i", str(VIDEO_PATH),
                          "-t", str(dur), "-c:v", "libx264", "-preset", "fast",
                          "-c:a", "aac", str(vid_path)
                      ]
                      subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                      
                      # Writing Detailed Metadata
                      meta_content = {
                          "file_info": {
                              "filename": vid_fname,
                              "duration_sec": round(dur, 2),
                              "source_time": f"{s}-{e}"
                          },
                          "content_strategy": {
                              "title": clip.get("title"),
                              "advisor_analysis": clip.get("viral_analysis"),
                              "transcript": clip.get("transcript_snippet")
                          },
                          "social_ready": clip.get("social_media"),
                          "ai_engine": "Director Mode (GPT-4 + Whisper Medium)"
                      }

                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(meta_content, f, indent=2, ensure_ascii=False)
                          
                      print(f"âœ¨ Exported: {vid_fname}")
                      
                  except Exception as ex:
                      print(f"âš ï¸ Failed to export clip: {ex}")

          if __name__ == "__main__":
              download_source()
              segs = listen_to_video()
              if not segs: sys.exit(1)
              
              decisions = director_decision(segs)
              if not decisions: 
                  print("âŒ AI Director tidak menemukan momen viral.")
                  sys.exit(1)
                  
              production(decisions)
              print("âœ… SEMUA SELESAI.")
          EOF

      - name: Run Director
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
        run: python ai_director.py

      - name: Upload Hasil Produksi
        uses: actions/upload-artifact@v4
        with:
          name: Viral_Shorts_Pack
          path: output/
          if-no-files-found: error
