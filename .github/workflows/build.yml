name: Viral Video Editor CI/CD

on:
  workflow_dispatch:
    inputs:
      youtube_url:
        description: 'YouTube URL'
        required: true
        default: 'https://youtu.be/wn717YmB1z0'
      api_key:
        description: 'API Key (OpenAI)'
        required: true
        default: ''

jobs:
  process-video:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Install Python dependencies
      run: |        
        # Install yt-dlp versi paling baru (penting!)
        pip install -U "yt-dlp[default]" 
        pip install faster-whisper numpy openai tqdm torch
        
    - name: Run Video Editor Script
      env:
        API_KEY: ${{ github.event.inputs.api_key }}
        YOUTUBE_URL: ${{ github.event.inputs.youtube_url }}
      run: |
        echo "üöÄ Starting Viral Video Editor..."
        
        mkdir -p output
        
        cat > video_editor.py << 'EOF'
        import os, sys, subprocess, json, time, re
        from pathlib import Path
        import torch
        from openai import OpenAI
        
        print("=" * 60)
        print("VIRAL VIDEO EDITOR - FIX BYPASS")
        print("=" * 60)
        
        # CONFIGURATION
        YOUTUBE_URL = os.getenv("YOUTUBE_URL", "").strip()
        API_KEY = os.getenv("API_KEY", "").strip()
        
        if not YOUTUBE_URL:
            print("‚ùå Error: URL Kosong")
            sys.exit(1)
            
        # ----------------------------
        # 1. DOWNLOADER (UPDATED STRATEGY)
        # ----------------------------
        def download_youtube(url: str, output_path="./video.mp4") -> Path:
            print(f"\nüì• DOWNLOADING VIDEO...")
            
            # Membersihkan URL (Hapus ?si=... dan tracking lainnya)
            if "?" in url:
                clean_url = url.split("?")[0]
            else:
                clean_url = url
            
            print(f"   Clean URL: {clean_url}")
            
            # STRATEGI BARU: Menggunakan Client iOS tanpa User-Agent manual
            # Client 'ios' seringkali lebih dipercaya daripada 'android' atau 'web' di Data Center
            cmd = [
               "yt-dlp",
                "-f", "bv*[ext=mp4]+ba[ext=m4a]/b[ext=mp4] / bv*+ba/b",
                "--force-overwrites",
                "--no-playlist",
                # Menggunakan iOS Client (Taktik Bypass)
                "--extractor-args", "youtube:player_client=ios",
                "--no-check-certificates",
                "-o", output_path,
                clean_url
            ]
            
            try:
                # Coba download dengan taktik iOS
                print("   üöÄ Attempting download with iOS client spoofing...")
                subprocess.run(cmd, check=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
                
                if Path(output_path).exists():
                    size = Path(output_path).stat().st_size / (1024 * 1024)
                    print(f"   ‚úÖ Download successful: {size:.1f} MB")
                    return Path(output_path)
            except subprocess.CalledProcessError as e:
                print(f"   ‚ö†Ô∏è iOS method failed. Error: {e.stderr}")
                
                # FALLBACK: Coba Web Client jika iOS gagal
                print("   üîÑ Trying Fallback (Web Client)...")
                cmd_fallback = [
                   "yt-dlp",
                    "-f", "b", # Quality rendah dulu biar connect
                    "--extractor-args", "youtube:player_client=web",
                    "-o", output_path,
                    clean_url
                ]
                try:
                    subprocess.run(cmd_fallback, check=True)
                    if Path(output_path).exists():
                        print(f"   ‚úÖ Download successful (Fallback mode)")
                        return Path(output_path)
                except Exception as ex:
                    print(f"   ‚ùå ALL METHODS FAILED. Google is blocking GitHub IP.")
                    raise Exception("Silakan gunakan Cookies.txt untuk video ini.")

        # ----------------------------
        # 2. AUDIO CONVERTER
        # ----------------------------
        def convert_to_audio(video_path):
            print(f"\nüîÑ EXTRACTING AUDIO")
            audio_path = Path("audio.wav")
            cmd = [
                "ffmpeg", "-y", "-i", str(video_path),
                "-vn", "-acodec", "pcm_s16le", "-ar", "16000", "-ac", "1",
                "-loglevel", "error", str(audio_path)
            ]
            subprocess.run(cmd, check=True)
            return audio_path

        # ----------------------------
        # 3. PROCESS & CUT
        # ----------------------------
        def process_and_cut(video_path):
            # Transcribe
            print("\nüéôÔ∏è TRANSCRIBING")
            from faster_whisper import WhisperModel
            model = WhisperModel("tiny", device="cpu", compute_type="int8")
            segments_gen, _ = model.transcribe(str(convert_to_audio(video_path)))
            
            text_full = ""
            for seg in segments_gen:
                text_full += seg.text + " "
                
            # GPT Request
            print("\nüß† GPT ANALYSIS")
            client = OpenAI(api_key=API_KEY, base_url="https://tes-coral.vercel.app/v1/")
            
            # Simple prompt agar output stabil
            prompt = f"""Extract 1 viral clip (max 30s). Return JSON: [{{"start": 10, "end": 20}}] Transcript: {text_full[:2000]}"""
            
            try:
                resp = client.chat.completions.create(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": prompt}]
                )
                content = resp.choices[0].message.content
                if "```" in content: content = content.split("```")[1].replace("json", "")
                cuts = json.loads(content)
            except:
                cuts = [{"start": 0, "end": 15}] # Fallback
            
            # Cut
            print("\n‚úÇÔ∏è CUTTING")
            results = []
            for i, cut in enumerate(cuts):
                out = Path(f"output/clip_{i}.mp4")
                subprocess.run([
                    "ffmpeg", "-y", "-i", str(video_path),
                    "-ss", str(cut['start']), "-to", str(cut['end']),
                    "-c:v", "libx264", "-preset", "ultrafast",
                    "-loglevel", "error", str(out)
                ])
                results.append(out)
            return results

        if __name__ == "__main__":
            try:
                vid = download_youtube(YOUTUBE_URL)
                res = process_and_cut(vid)
                
                import zipfile
                with zipfile.ZipFile("viral_segments.zip", 'w') as z:
                    for f in res: z.write(f, f.name)
                print("\n‚úÖ SUCCESS")
            except Exception as e:
                print(f"\n‚ùå FATAL: {e}")
                sys.exit(1)
        EOF
        
        python video_editor.py
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: viral-video-segments
        path: viral_segments.zip
