name: Build crosstool-NG (xtensa-esp32-elf)

on:
  workflow_dispatch:

jobs:
  compile:
    # gunakan runner yang memang ARM64. Jika hosted ARM64 tersedia di org Anda, ganti sesuai.
    runs-on: ubuntu-22.04

    env:
      # HOST runner triplet (where compiler will run)
      CT_HOST_TRIPLET: aarch64-unknown-linux-gnu
      # TARGET (what the generated toolchain produces)
      TARGET: xtensa-esp32-elf
      # Prefix dir must include target so outputs go to x-tools/<target>
      CT_PREFIX_DIR: ${{ github.workspace }}/x-tools/${{ env.TARGET }}
      CROSSTOOL_NG_VERSION: esp-2021r2
      WORKSPACE: ${{ github.workspace }}
      CT_LOCAL_TARBALLS_DIR: ${{ github.workspace }}/.build/tarballs

    steps:
    - name: Show runner info (sanity)
      run: |
        echo "uname -m: $(uname -m)"
        if [ "$(uname -m)" != "aarch64" ]; then
          echo "WARNING: runner is not aarch64. This job expects an aarch64 runner (BUILD/HOST = aarch64-unknown-linux-gnu)."
        fi

    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Install build deps
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          build-essential autoconf automake bison flex texinfo gawk \
          libtool libncurses5-dev python3 python3-distutils python3-pip \
          gperf wget unzip pkg-config ca-certificates cmake cmake-data \
          libgmp-dev libmpfr-dev libmpc-dev lzip xz-utils rsync bzip2

    - name: Prepare workspace dirs
      run: |
        rm -rf crosstool-ng .build x-tools artifacts || true
        mkdir -p crosstool-ng .build x-tools artifacts "${CT_LOCAL_TARBALLS_DIR}"

    - name: Clone crosstool-NG (esp branch) and init overlays
      run: |
        git clone https://github.com/espressif/crosstool-NG.git -b ${CROSSTOOL_NG_VERSION} crosstool-ng
        cd crosstool-ng
        git submodule update --init --recursive
        # ensure overlays folder exists (required by espressif branch)
        if [ ! -d "overlays/xtensa_esp32" ]; then
          echo "FATAL: required overlays missing"
          ls -la overlays || true
          exit 1
        fi

    - name: Build & install ct-ng locally
      run: |
        cd crosstool-ng
        ./bootstrap
        ./configure --enable-local --prefix=/usr/local
        make -j$(nproc)
        sudo make install

    - name: Create ct-ng config and adjust for ESP target
      run: |
        cd crosstool-ng
        # create/overwrite .config tailored for target
        cat > .config <<EOF
CT_PREFIX_DIR="${CT_PREFIX_DIR}"
CT_BUILD="${CT_HOST_TRIPLET}"
CT_HOST="${CT_HOST_TRIPLET}"
CT_TARGET="${TARGET}"
EOF
        # For esp32 ensure arch/core is set (ct-ng expects CT_ARCH_XTENSA_CORE)
        if [[ "${TARGET}" == *"esp32"* ]]; then
          if ! grep -q "CT_ARCH_XTENSA_CORE" .config; then
            echo 'CT_ARCH_XTENSA_CORE="esp32"' >> .config
          fi
          # ensure no kernel
          if grep -q "CT_KERNEL" .config; then
            sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config
          else
            echo 'CT_KERNEL="none"' >> .config
          fi
        fi

    - name: Run ct-ng build (non-interactive)
      run: |
        cd crosstool-ng
        rm -rf .build/${TARGET} || true
        export CT_NG_BUILD_FORCE=1
        export CT_ALLOW_BUILD_AS_ROOT=y
        export CT_ALLOW_BUILD_AS_ROOT_SURE=y
        export HOME=${WORKSPACE}
        yes "" | ./ct-ng oldconfig || true
        ./ct-ng build 2>&1 | tee "${WORKSPACE}/x-tools/${TARGET}/build.log" || true

    - name: Validate generated toolchain (check gcc)
      run: |
        GCC_PATH="${CT_PREFIX_DIR}/bin/${TARGET}-gcc"
        echo "Checking for: $GCC_PATH"
        if [ ! -x "$GCC_PATH" ]; then
          echo "FATAL: GCC binary tidak ditemukan di: $GCC_PATH"
          echo "Isi folder parent:"
          ls -R "$(dirname "$CT_PREFIX_DIR")" || true
          # copy build log for debugging
          if [ -f "${CT_PREFIX_DIR}/build.log" ]; then
            tail -n 200 "${CT_PREFIX_DIR}/build.log" || true
          fi
          exit 1
        fi
        $GCC_PATH --version | head -n1

    - name: Package artifact
      run: |
        ARTIFACT_NAME="${TARGET}-gcc-${CROSSTOOL_NG_VERSION}-linux-arm64.tar.gz"
        cd "${GITHUB_WORKSPACE}/x-tools"
        tar -czf "${GITHUB_WORKSPACE}/artifacts/${ARTIFACT_NAME}" "${TARGET}"
        echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: toolchain-${{ env.TARGET }}
        path: artifacts/
