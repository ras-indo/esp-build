
name: Build ESP-IDF Toolchains (ARM64 Host) - Auto

on:
  push:
    branches:
      - 'main'
      - 'releases/**'

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - xtensa-lx106-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV

      - name: Cache toolchains and ct-ng cache
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CT_PREFIX_DIR }}
            ~/.cache/ct-ng
          key: arm64-ctng-${{ matrix.target }}-${{ env.CROSSTOOL_NG_VERSION }}-${{ hashFiles('.github/workflows/build.yml') }}

      - name: Install build dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev \
            python3 python3-dev python3-distutils \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download and setup crosstool-NG (Espressif Fork)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          echo "Using Espressif fork ($CROSSTOOL_NG_VERSION) for ESP targets"

      - name: Build and install crosstool-NG
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local
          make -j$(nproc)
          sudo make install

      - name: Create configuration for ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          
          echo "Creating configuration for $TARGET..."
          
          # Coba gunakan sample config yang ada di fork Espressif
          if [ -f "configs/$TARGET/crosstool.config" ]; then
            echo "Using config from Espressif fork: configs/$TARGET/crosstool.config"
            cp "configs/$TARGET/crosstool.config" .config
          elif [ -f "samples/$TARGET/crosstool.config" ]; then
            echo "Using sample config: samples/$TARGET/crosstool.config"
            cp "samples/$TARGET/crosstool.config" .config
          else
            echo "No existing config found, creating basic configuration..."
            
            # BUAT KONFIGURASI DENGAN echo TANPA HEREDOC
            # Konfigurasi dasar untuk semua target
            echo "CT_EXPERIMENTAL=y" > .config
            echo "CT_ALLOW_BUILD_AS_ROOT=y" >> .config
            echo "CT_ALLOW_BUILD_AS_ROOT_SURE=y" >> .config
            echo "CT_KERNEL_BARE_METAL=y" >> .config
            echo "CT_LIBC_NEWLIB=y" >> .config
            echo "CT_CC_LANG_CXX=y" >> .config
            echo "CT_CC_GCC_ENABLE_TARGET_OPTSPACE=y" >> .config
            echo "CT_DEBUG_GDB=y" >> .config
            echo "CT_BINUTILS_LINKER_LD_GOLD=y" >> .config
            echo "CT_BINUTILS_LINKER_LD_BFD=y" >> .config
            echo "CT_BINUTILS_LINKER_LD_DEFAULT=\"bfd\"" >> .config
            
            # Pengaturan spesifik berdasarkan target
            if [[ "$TARGET" == "xtensa-esp32-elf" ]]; then
              echo "CT_TARGET=\"xtensa-esp32-elf\"" >> .config
              echo "CT_ARCH=\"xtensa\"" >> .config
              echo "CT_ARCH_XTENSA_CORE=\"esp32\"" >> .config
              echo "CT_ARCH_XTENSA_SYSTEM=\"lx6\"" >> .config
            elif [[ "$TARGET" == "xtensa-esp32s2-elf" ]]; then
              echo "CT_TARGET=\"xtensa-esp32s2-elf\"" >> .config
              echo "CT_ARCH=\"xtensa\"" >> .config
              echo "CT_ARCH_XTENSA_CORE=\"esp32s2\"" >> .config
              echo "CT_ARCH_XTENSA_SYSTEM=\"lx7\"" >> .config
            elif [[ "$TARGET" == "xtensa-esp32s3-elf" ]]; then
              echo "CT_TARGET=\"xtensa-esp32s3-elf\"" >> .config
              echo "CT_ARCH=\"xtensa\"" >> .config
              echo "CT_ARCH_XTENSA_CORE=\"esp32s3\"" >> .config
              echo "CT_ARCH_XTENSA_SYSTEM=\"lx7\"" >> .config
            elif [[ "$TARGET" == "xtensa-lx106-elf" ]]; then
              echo "CT_TARGET=\"xtensa-lx106-elf\"" >> .config
              echo "CT_ARCH=\"xtensa\"" >> .config
              echo "CT_ARCH_XTENSA_CORE=\"lx106\"" >> .config
              echo "CT_ARCH_XTENSA_SYSTEM=\"lx106\"" >> .config
            elif [[ "$TARGET" == "riscv32-esp-elf" ]]; then
              echo "CT_TARGET=\"riscv32-esp-elf\"" >> .config
              echo "CT_ARCH=\"riscv\"" >> .config
              echo "CT_ARCH_RISCV_ARCH=\"rv32imafc\"" >> .config
              echo "CT_ARCH_RISCV_ABI=\"ilp32f\"" >> .config
              echo "CT_ARCH_RISCV_TUNE=\"rocket\"" >> .config
            fi
          fi
          
          # Update dengan pengaturan ARM64 host
          echo "CT_HOST=\"${CT_HOST_TRIPLET}\"" >> .config
          echo "CT_PREFIX_DIR=\"${CT_PREFIX_DIR}\"" >> .config
          echo "CT_LOG_PROGRESS_BAR=n" >> .config
          echo "CT_LOG_LEVEL_MAX=INFO" >> .config
          
          # Hapus duplikasi
          sort -u .config -o .config
          sed -i '/^$/d' .config
          
          # Tampilkan konfigurasi untuk debugging
          echo "Configuration created. First 20 lines:"
          head -20 .config
          
          # Simpan untuk backup
          cp .config "$GITHUB_WORKSPACE/.config-$TARGET-generated"

      - name: Validate and finalize configuration
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          
          echo "Validating configuration with ct-ng..."
          
          # Jalankan ct-ng oldconfig untuk mengisi nilai default yang hilang
          if ./ct-ng oldconfig </dev/null 2>&1 | tee oldconfig.log; then
            echo "oldconfig completed successfully"
          else
            echo "oldconfig had issues, but continuing..."
          fi
          
          # Cek apakah konfigurasi valid
          if ./ct-ng show-config > show-config.log 2>&1; then
            echo "Configuration validation PASSED"
            cat show-config.log | head -20
          else
            echo "Configuration validation FAILED"
            echo "Error output:"
            cat show-config.log
            echo "Current configuration:"
            cat .config | head -50
            exit 1
          fi
          
          # Simpan konfigurasi final
          cp .config "$GITHUB_WORKSPACE/.config-$TARGET-final"

      - name: Download missing tarballs manually (PERBAIKAN UTAMA)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          
          # Buat direktori untuk tarball
          mkdir -p .build/tarballs
          
          echo "Downloading required tarballs manually..."
          
          # Download komponen yang sering gagal dari mirror yang lebih andal
          # Daftar tarball yang diperlukan berdasarkan error sebelumnya
          TARBALLS=(
            "isl-0.19.tar.xz:https://gcc.gnu.org/pub/gcc/infrastructure/isl-0.19.tar.xz"
            "zlib-1.2.11.tar.xz:https://zlib.net/zlib-1.2.11.tar.xz"
            "gmp-6.2.0.tar.xz:https://gmplib.org/download/gmp/gmp-6.2.0.tar.xz"
            "mpfr-4.0.2.tar.xz:https://www.mpfr.org/mpfr-4.0.2/mpfr-4.0.2.tar.xz"
            "binutils-2.35.tar.xz:https://ftp.gnu.org/gnu/binutils/binutils-2.35.tar.xz"
            "gcc-10.2.0.tar.xz:https://ftp.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.xz"
            "newlib-3.3.0.tar.gz:https://sourceware.org/pub/newlib/newlib-3.3.0.tar.gz"
            "linux-5.4.86.tar.xz:https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.4.86.tar.xz"
          )
          
          for tarball_info in "${TARBALLS[@]}"; do
            filename="${tarball_info%%:*}"
            url="${tarball_info#*:}"
            
            if [ ! -f ".build/tarballs/$filename" ]; then
              echo "Downloading $filename..."
              wget -q --tries=3 --timeout=30 -O ".build/tarballs/$filename" "$url" || {
                echo "Failed to download $filename from $url"
                echo "Trying alternative source..."
                # Coba dari GNU mirror
                wget -q --tries=2 --timeout=20 -O ".build/tarballs/$filename" "https://ftpmirror.gnu.org/${filename}" || true
              }
              
              if [ -f ".build/tarballs/$filename" ]; then
                echo "  ✓ $filename downloaded"
                ls -lh ".build/tarballs/$filename"
              else
                echo "  ✗ $filename failed to download"
              fi
            else
              echo "  ✓ $filename already exists"
            fi
          done
          
          echo "Tarball preparation complete"

      - name: Build toolchain ${{ matrix.target }}
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd crosstool-ng
          export HOME=$GITHUB_WORKSPACE
          
          # Buat direktori output
          mkdir -p "${CT_PREFIX_DIR}"
          
          echo "Building $TARGET on ARM64..."
          
          # Tampilkan info sistem
          echo "System info:"
          uname -a
          echo "CPU cores: $(nproc)"
          
          # Set environment variables untuk mirror yang lebih andal
          export CT_ISL_MIRROR="https://gcc.gnu.org/pub/gcc/infrastructure"
          export CT_ZLIB_MIRROR="https://zlib.net"
          export CT_GMP_MIRROR="https://gmplib.org/download/gmp"
          export CT_MPFR_MIRROR="https://www.mpfr.org"
          export CT_BINUTILS_MIRROR="https://ftp.gnu.org/gnu/binutils"
          export CT_GCC_MIRROR="https://ftp.gnu.org/gnu/gcc"
          export CT_NEWLIB_MIRROR="https://sourceware.org/pub/newlib"
          export CT_LINUX_MIRROR="https://cdn.kernel.org/pub/linux/kernel"
          
          # Build dengan log verbose
          set -x
          ./ct-ng build 2>&1 | tee build-$TARGET.log
          BUILD_STATUS=${PIPESTATUS[0]}
          set +x
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "Build $TARGET SUCCESSFUL!"
          else
            echo "Build $TARGET FAILED. Checking for specific errors..."
            
            # Cek error spesifik
            if grep -q "download failed" build-$TARGET.log; then
              echo "Download error detected. Trying with local tarballs..."
              
              # Tampilkan tarball yang tersedia
              echo "Available tarballs in .build/tarballs/:"
              ls -la .build/tarballs/ 2>/dev/null || echo "No tarballs directory"
              
              # Coba build lagi dengan skip download
              echo "Retrying build..."
              ./ct-ng build 2>&1 | tee build-$TARGET-retry.log || {
                echo "Retry also failed"
                exit 1
              }
            else
              echo "Non-download error. Last 50 lines of log:"
              tail -50 build-$TARGET.log
              exit 1
            fi
          fi

      - name: Verify and package toolchain
        id: package
        run: |
          # Verifikasi toolchain
          TOOLCHAIN_BIN="${CT_PREFIX_DIR}/${TARGET}/bin/${TARGET}-gcc"
          if [ -f "$TOOLCHAIN_BIN" ] && [ -x "$TOOLCHAIN_BIN" ]; then
            echo "Toolchain $TARGET built successfully"
            echo "Version info:"
            "$TOOLCHAIN_BIN" --version | head -3
            
            # Test compile
            echo 'int main() { return 0; }' > test.c
            if "$TOOLCHAIN_BIN" -o test.elf test.c 2>/dev/null; then
              echo "Test compilation PASSED"
              file test.elf
              rm -f test.c test.elf
            else
              echo "Test compilation failed, but toolchain exists"
              rm -f test.c
            fi
          else
            echo "ERROR: Toolchain binary not found or not executable"
            echo "Expected path: $TOOLCHAIN_BIN"
            echo "Directory listing:"
            ls -la "${CT_PREFIX_DIR}/${TARGET}/bin/" 2>/dev/null || echo "Directory not found"
            exit 1
          fi
          
          # Package toolchain
          mkdir -p artifacts
          ASSET="${TARGET}-host-arm64.tar.gz"
          if [ -d "${CT_PREFIX_DIR}/${TARGET}" ]; then
            echo "Packaging ${CT_PREFIX_DIR}/${TARGET}"
            tar -czf "artifacts/${ASSET}" -C "${CT_PREFIX_DIR}" "${TARGET}"
            echo "Created artifact: ${ASSET}"
          else
            echo "ERROR: Toolchain directory not found"
            exit 1
          fi
          
          # Generate checksum
          sha256sum "artifacts/${ASSET}" > "artifacts/${ASSET}.sha256"
          echo "asset_name=${ASSET}" >> $GITHUB_OUTPUT
          echo "asset_path=artifacts/${ASSET}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.asset_name }}
          path: |
            artifacts/
          retention-days: 30

  summary:
    needs: compile
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "# ESP-IDF Toolchain Build Summary" > summary.md
          echo "" >> summary.md
          echo "**Build completed:** $(date)" >> summary.md
          echo "" >> summary.md
          echo "## Targets attempted:" >> summary.md
          echo "- xtensa-esp32-elf" >> summary.md
          echo "- xtensa-esp32s2-elf" >> summary.md
          echo "- xtensa-esp32s3-elf" >> summary.md
          echo "- xtensa-lx106-elf" >> summary.md
          echo "- riscv32-esp-elf" >> summary.md
          echo "" >> summary.md
          echo "## Next steps:" >> summary.md
          echo "1. Download artifacts from the Actions tab" >> summary.md
          echo "2. Extract toolchains: \`tar -xzf <toolchain>.tar.gz\`" >> summary.md
          echo "3. Add to PATH: \`export PATH=\$PATH:/path/to/toolchain/bin\`" >> summary.md
          cat summary.md
