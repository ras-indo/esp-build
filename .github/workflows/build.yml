name: ðŸ§  Viral Shorts â€” AI Brain (Fixed Imports)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Jumlah Klip'
        required: false
        default: '5'
      ai_creativity:
        description: 'Creativity (0.0 - 1.0)'
        required: false
        default: '0.7'

jobs:
  ai-editor-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Menginstall core dan community untuk memastikan module lengkap
          python -m pip install -q yt-dlp ffmpeg-python openai langchain langchain-core langchain-community langchain-openai tiktoken
          python -m pip install -q git+https://github.com/openai/whisper.git

      - name: Create Intelligent Editor Script
        run: |
          cat > ai_editor.py << 'EOF'
          import os
          import json
          import subprocess
          import sys
          import whisper
          from pathlib import Path
          
          # --- FIXED IMPORTS FOR LANGCHAIN v0.2/0.3+ ---
          try:
              from langchain_openai import ChatOpenAI
              # Import Prompts dari Core (lebih stabil)
              from langchain_core.prompts import ChatPromptTemplate
              # Import Parser
              from langchain.output_parsers import ResponseSchema, StructuredOutputParser
          except ImportError as e:
              # Fallback jika struktur berubah lagi
              print(f"Import Error: {e}")
              from langchain.prompts import ChatPromptTemplate
              from langchain.output_parsers import ResponseSchema, StructuredOutputParser

          # === KONFIGURASI CUSTOM ===
          CUSTOM_API_KEY = "Kontolondon"
          CUSTOM_BASE_URL = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          TEMP = float(os.environ.get("AI_CREATIVITY", 0.7))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"

          # === 1. DOWNLOAD VIDEO ===
          def download_video():
              print(f"â¬‡ï¸ Downloading video...")
              # Menggunakan yt-dlp
              subprocess.run(["yt-dlp", VIDEO_URL, "-o", str(VIDEO_PATH), "--force-overwrites"], stdout=subprocess.DEVNULL)
              if not VIDEO_PATH.exists() or VIDEO_PATH.stat().st_size < 1000:
                  print("ðŸ”„ Switch to Curl...")
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)])
              
              if VIDEO_PATH.exists():
                  print("âœ… Video ready.")
              else:
                  raise Exception("Gagal download video.")

          # === 2. WHISPER (PENDENGARAN) ===
          def transcribe_video():
              print("ðŸ‘‚ Menggunakan Whisper untuk mendengar...")
              model = whisper.load_model("small") 
              result = model.transcribe(str(VIDEO_PATH))
              return result["segments"]

          # === 3. LANGCHAIN BRAIN (OTAK EDITOR) ===
          def ai_editorial_decision(segments):
              print("ðŸ§  AI Editor sedang berpikir (Menghubungkan ke Custom Brain)...")
              
              transcript_context = ""
              for seg in segments:
                  start_t = int(seg['start'])
                  transcript_context += f"[{start_t}s] {seg['text']}\n"

              # Definisi Output JSON
              response_schemas = [
                  ResponseSchema(name="clips", description="List klip video. Setiap klip harus punya: start_time (float), end_time (float), title (string), viral_reasoning (string), emotion (string)")
              ]
              output_parser = StructuredOutputParser.from_response_schemas(response_schemas)
              format_instructions = output_parser.get_format_instructions()

              # Inisialisasi LLM
              llm = ChatOpenAI(
                  temperature=TEMP,
                  model="gpt-3.5-turbo",
                  openai_api_key=CUSTOM_API_KEY,
                  openai_api_base=CUSTOM_BASE_URL
              )

              # Prompt System
              template_string = """
              Kamu adalah Editor Video Profesional untuk konten Short/TikTok.
              Tugasmu adalah membaca transkrip video berikut dan memilih {num_clips} bagian paling viral.

              KRITERIA PEMILIHAN:
              1. Hook kuat di awal.
              2. Cerita koheren (nyambung).
              3. Emosi: Lucu, Mengejutkan, Informatif, atau Sedih.
              4. Durasi: 15-60 detik.
              5. JANGAN ambil intro/outro ("Halo guys", "Subscribe").

              TRANSKRIP:
              {transcript}

              {format_instructions}
              """

              prompt = ChatPromptTemplate.from_template(template_string)
              
              # Batasi panjang transkrip (token saving)
              transcript_slice = transcript_context[:12000] 
              
              messages = prompt.format_messages(
                  num_clips=NUM_CLIPS,
                  transcript=transcript_slice,
                  format_instructions=format_instructions
              )

              try:
                  response = llm.invoke(messages)
                  print("âœ… Keputusan AI diterima.")
                  
                  # Jika response content kosong/salah
                  if not response.content:
                      print("âš ï¸ Response AI kosong.")
                      return []

                  # Parsing
                  # Bersihkan markdown code blocks ```json ... ``` jika ada
                  content = response.content.strip()
                  if content.startswith("```json"):
                      content = content.replace("```json", "").replace("```", "")
                  elif content.startswith("```"):
                       content = content.replace("```", "")
                  
                  parsed_data = output_parser.parse(content)
                  return parsed_data["clips"]
              except Exception as e:
                  print(f"âŒ Error saat AI berpikir: {e}")
                  # Print raw untuk debugging
                  if 'response' in locals():
                      print("Raw response preview:", response.content[:500])
                  return []

          # === 4. FFMPEG (TANGAN EDITOR) ===
          def cut_and_save(clips_data):
              print("âœ‚ï¸ Memotong video sesuai perintah AI...")
              
              for idx, clip in enumerate(clips_data):
                  try:
                      start = float(clip["start_time"])
                      end = float(clip["end_time"])
                      duration = end - start
                      
                      if duration < 5: continue 

                      filename = f"short_{idx+1:02d}.mp4"
                      out_path = OUTDIR / filename
                      json_path = OUTDIR / f"short_{idx+1:02d}_meta.json"

                      cmd = [
                          "ffmpeg", "-y",
                          "-ss", str(start),
                          "-i", str(VIDEO_PATH),
                          "-t", str(duration),
                          "-c:v", "libx264", "-c:a", "aac", 
                          "-preset", "fast",
                          str(out_path)
                      ]
                      subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

                      metadata = {
                          "filename": filename,
                          "title": clip.get("title", "Untitled"),
                          "reasoning": clip.get("viral_reasoning", ""),
                          "emotion": clip.get("emotion", "neutral"),
                          "timing": {"start": start, "end": end}
                      }
                      
                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(metadata, f, indent=2, ensure_ascii=False)
                      
                      print(f"ðŸ‘‰ Exported: {filename}")
                  except Exception as ex:
                      print(f"Gagal memproses klip {idx}: {ex}")

          # === MAIN ===
          if __name__ == "__main__":
              try:
                  download_video()
                  raw_segments = transcribe_video()
                  selected_clips = ai_editorial_decision(raw_segments)
                  
                  if selected_clips:
                      cut_and_save(selected_clips)
                  else:
                      print("âš ï¸ Tidak ada klip yang dihasilkan.")
                      
              except Exception as e:
                  print(f"âŒ Critical Error: {e}")
                  sys.exit(1)
          EOF

      - name: Run Pipeline
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
          AI_CREATIVITY: ${{ github.event.inputs.ai_creativity }}
        run: python ai_editor.py

      - name: Zip Results
        run: zip -r viral_shorts_pack.zip output

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Custom-Result
          path: viral_shorts_pack.zip
