name: üß† Viral Shorts ‚Äî AI Brain (Fixed Imports)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Jumlah Klip'
        required: false
        default: '5'
      ai_creativity:
        description: 'Creativity (0.0 - 1.0)'
        required: false
        default: '0.7'

jobs:
  ai-editor-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg libsm6 libxext6 libgl1

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -q yt-dlp openai tiktoken
          # Install LangChain dengan VERSI TEPAT - pakai versi 0.1.x bukan 1.0
          python -m pip install -q "langchain==0.1.16" "langchain-core==0.1.44" "langchain-openai==0.0.8"
          python -m pip install -q "openai-whisper>=20231117"
          python -m pip install -q "moviepy>=1.0.3"

      - name: Create AI Editor Script (Fixed Version)
        run: |
          cat > ai_editor.py << 'EOF'
          import os
          import json
          import subprocess
          import sys
          import whisper
          from pathlib import Path
          
          # === IMPORTS YANG BENAR UNTUK LANGCHAIN 0.1.x ===
          # Versi 0.1.x menggunakan struktur import ini
          from langchain_openai import ChatOpenAI
          from langchain_core.prompts import ChatPromptTemplate
          # ResponseSchema tidak ada di versi 0.1, kita ganti dengan pendekatan lain
          
          # === IMPORTS MOVIEPY ===
          from moviepy.editor import VideoFileClip, TextClip, CompositeVideoClip
          from moviepy.video.fx.all import resize
          
          # === KONFIGURASI CUSTOM ===
          CUSTOM_API_KEY = "Kontolondon"
          CUSTOM_BASE_URL = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          TEMPERATURE = float(os.environ.get("AI_CREATIVITY", 0.7))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"
          
          # === 1. DOWNLOAD VIDEO ===
          def download_video():
              print(f"‚¨áÔ∏è Downloading video...")
              try:
                  subprocess.run([
                      "yt-dlp", VIDEO_URL, 
                      "-o", str(VIDEO_PATH), 
                      "--force-overwrites",
                      "--quiet"
                  ], check=True, stderr=subprocess.DEVNULL)
              except subprocess.CalledProcessError:
                  print("üîÑ yt-dlp gagal, mencoba curl...")
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)], 
                                stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
              
              if VIDEO_PATH.exists() and VIDEO_PATH.stat().st_size > 1000:
                  print(f"‚úÖ Video siap ({VIDEO_PATH.stat().st_size // 1024} KB)")
              else:
                  raise Exception("‚ùå Gagal download video.")
          
          # === 2. WHISPER TRANSCRIPTION ===
          def transcribe_video():
              print("üëÇ Menggunakan Whisper untuk transkripsi...")
              model = whisper.load_model("small")
              result = model.transcribe(
                  str(VIDEO_PATH),
                  language="id",
                  task="transcribe"
              )
              return result["segments"]
          
          # === 3. AI EDITORIAL DECISION (DENGAN JSON PARSING MANUAL) ===
          def ai_editorial_decision(segments):
              print("üß† AI Editor menganalisis konten...")
              
              # Format transkrip dengan timestamp
              transcript_lines = []
              for seg in segments[:50]:  # Batasi jumlah segment untuk efisiensi
                  start_min = int(seg['start']) // 60
                  start_sec = int(seg['start']) % 60
                  text = seg['text'].strip()
                  transcript_lines.append(f"[{start_min:02d}:{start_sec:02d}] {text}")
              
              transcript_text = "\n".join(transcript_lines)
              
              # Inisialisasi LLM dengan API custom
              llm = ChatOpenAI(
                  temperature=TEMPERATURE,
                  model="gpt-3.5-turbo",
                  openai_api_key=CUSTOM_API_KEY,
                  openai_api_base=CUSTOM_BASE_URL,
                  max_tokens=2000
              )
              
              # Prompt template dengan instruksi JSON yang jelas
              prompt_template = """
              Kamu adalah Editor Video Professional untuk konten Shorts/TikTok/Reels.
              
              TUGAS: Pilih {num_clips} klip terbaik dari transkrip video berikut.
              
              KRITERIA KLIP VIRAL:
              1. Hook kuat di 3 detik pertama
              2. Cerita yang koheren dan lengkap (ada awal-tengah-akhir)
              3. Emosi yang kuat (lucu, mengejutkan, informatif, atau mengharukan)
              4. Durasi ideal: 15-60 detik
              5. Hindari bagian intro/outro yang membosankan
              
              INSTRUKSI OUTPUT:
              Kamu HARUS mengembalikan output dalam format JSON berikut:
              {{
                "clips": [
                  {{
                    "start_time": 10.5,
                    "end_time": 45.2,
                    "title": "Judul klip 1",
                    "viral_reasoning": "Alasan kenapa klip ini viral",
                    "emotion": "funny"
                  }},
                  {{
                    "start_time": 65.0,
                    "end_time": 110.5,
                    "title": "Judul klip 2",
                    "viral_reasoning": "Alasan kenapa klip ini viral",
                    "emotion": "surprising"
                  }}
                ]
              }}
              
              INSTRUKSI TEKNIS:
              - Setiap klip HARUS memiliki start_time dan end_time yang akurat (dalam detik, angka desimal)
              - Durasi minimal 15 detik, maksimal 90 detik
              - Pastikan tidak ada klip yang tumpang tindih
              - Untuk "emotion": pilih dari: funny, surprising, informative, emotional, neutral
              - Jumlah klip: {num_clips}
              
              TRANSCRIPT VIDEO:
              {transcript}
              
              Hanya kembalikan JSON, tidak ada teks lain.
              """
              
              prompt = ChatPromptTemplate.from_template(prompt_template)
              
              messages = prompt.format_messages(
                  num_clips=NUM_CLIPS,
                  transcript=transcript_text[:8000]  # Batasi panjang transkrip
              )
              
              try:
                  print("üîÑ Memproses dengan AI...")
                  response = llm.invoke(messages)
                  
                  # Bersihkan response dari markdown code blocks dan whitespace
                  content = response.content.strip()
                  
                  # Cari JSON dalam response (mungkin diawali dengan ```json atau hanya JSON)
                  if "```json" in content:
                      content = content.split("```json")[1].split("```")[0].strip()
                  elif "```" in content:
                      content = content.split("```")[1].split("```")[0].strip()
                  
                  # Parse JSON
                  import json as json_module
                  parsed_data = json_module.loads(content)
                  clips = parsed_data.get("clips", [])
                  
                  # Validasi klip
                  valid_clips = []
                  for clip in clips:
                      # Pastikan semua field ada
                      if not all(key in clip for key in ["start_time", "end_time", "title", "viral_reasoning", "emotion"]):
                          print(f"‚ö†Ô∏è Klip dibuang: field tidak lengkap")
                          continue
                          
                      duration = float(clip["end_time"]) - float(clip["start_time"])
                      if 15 <= duration <= 90:
                          valid_clips.append(clip)
                      else:
                          print(f"‚ö†Ô∏è Klip dibuang: durasi {duration:.1f}s di luar range")
                  
                  print(f"‚úÖ Ditemukan {len(valid_clips)} klip valid")
                  return valid_clips
                  
              except Exception as e:
                  print(f"‚ùå Error dalam AI decision: {str(e)}")
                  if 'response' in locals():
                      print(f"Raw response (200 chars): {response.content[:200]}")
                  return []
          
          # === 4. VIDEO CUTTING DENGAN MOVIEPY ===
          def cut_and_save(clips_data):
              print("‚úÇÔ∏è Memotong video dengan MoviePy...")
              
              if not clips_data:
                  print("‚ö†Ô∏è Tidak ada klip untuk dipotong")
                  return
              
              # Buka video source
              source_video = VideoFileClip(str(VIDEO_PATH))
              
              for idx, clip in enumerate(clips_data):
                  try:
                      start = float(clip["start_time"])
                      end = float(clip["end_time"])
                      duration = end - start
                      
                      # Pastikan tidak melebihi durasi video
                      if end > source_video.duration:
                          end = source_video.duration
                          duration = end - start
                          
                          if duration < 5:
                              print(f"‚è≠Ô∏è Klip {idx+1} terlalu pendek setelah adjust, dilewati")
                              continue
                      
                      # Generate nama file
                      emotion = clip.get("emotion", "neutral")
                      filename = f"short_{idx+1:02d}_{emotion}.mp4"
                      out_path = OUTDIR / filename
                      json_path = OUTDIR / f"short_{idx+1:02d}_meta.json"
                      
                      # Potong video
                      subclip = source_video.subclip(start, end)
                      
                      # Konversi ke format vertikal (9:16) untuk Shorts
                      def convert_to_vertical(clip):
                          # Dapatkan dimensi asli
                          w, h = clip.size
                          
                          # Target untuk Shorts: 1080x1920 (9:16)
                          target_w, target_h = 1080, 1920
                          
                          # Hitung scaling factor untuk memenuhi tinggi
                          scale_factor = target_h / h
                          new_w = int(w * scale_factor)
                          new_h = target_h
                          
                          # Resize dengan menjaga aspect ratio
                          resized_clip = resize(clip, width=new_w, height=new_h)
                          
                          # Jika terlalu lebar, crop tengahnya
                          if new_w > target_w:
                              # Crop horizontal dari tengah
                              x_center = (new_w - target_w) // 2
                              cropped_clip = resized_clip.crop(x1=x_center, x2=x_center + target_w)
                              return cropped_clip
                          else:
                              # Jika tidak cukup lebar, buat canvas hitam
                              from moviepy.video.VideoClip import ColorClip
                              background = ColorClip(
                                  size=(target_w, target_h),
                                  color=(0, 0, 0),
                                  duration=clip.duration
                              )
                              
                              # Posisikan video di tengah canvas
                              x_center = (target_w - new_w) // 2
                              
                              # Composite video di atas background
                              final_clip = CompositeVideoClip([
                                  background,
                                  resized_clip.set_position((x_center, 0))
                              ])
                              
                              return final_clip
                      
                      # Konversi ke vertikal
                      vertical_clip = convert_to_vertical(subclip)
                      
                      # Tambahkan judul sebagai teks (opsional)
                      title = clip.get("title", f"Klip {idx+1}")
                      if len(title) < 50 and duration > 3:  # Hanya tambahkan jika judul tidak terlalu panjang
                          try:
                              # Teks hanya muncul di 3 detik pertama
                              txt_clip = TextClip(
                                  title,
                                  fontsize=40,
                                  color='white',
                                  font='Arial-Bold',
                                  stroke_color='black',
                                  stroke_width=2,
                                  method='caption',
                                  size=(1000, 100)
                              ).set_position(('center', 100)).set_duration(min(3, duration))
                              
                              final_clip = CompositeVideoClip([
                                  vertical_clip,
                                  txt_clip
                              ])
                          except Exception as e:
                              print(f"‚ö†Ô∏è Gagal tambah teks: {e}")
                              final_clip = vertical_clip
                      else:
                          final_clip = vertical_clip
                      
                      # Export video
                      final_clip.write_videofile(
                          str(out_path),
                          codec='libx264',
                          audio_codec='aac',
                          fps=30,
                          preset='fast',
                          audio_bitrate='128k',
                          temp_audiofile=str(WORKDIR / f'temp_audio_{idx}.m4a'),
                          remove_temp=True,
                          logger=None,
                          threads=4
                      )
                      
                      # Tutup clip untuk menghemat memory
                      final_clip.close()
                      subclip.close()
                      
                      # Simpan metadata
                      metadata = {
                          "filename": filename,
                          "title": clip.get("title", f"Klip {idx+1}"),
                          "reasoning": clip.get("viral_reasoning", ""),
                          "emotion": emotion,
                          "timing": {"start": start, "end": end, "duration": duration},
                          "resolution": "1080x1920"
                      }
                      
                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(metadata, f, indent=2, ensure_ascii=False)
                      
                      print(f"‚úÖ {filename} ({duration:.1f}s) - {title}")
                      
                  except Exception as ex:
                      print(f"‚ùå Gagal memproses klip {idx}: {str(ex)}")
                      import traceback
                      traceback.print_exc()
              
              # Tutup video source
              source_video.close()
          
          # === 5. MAIN EXECUTION ===
          def main():
              print("=" * 50)
              print("üß† VIRAL SHORTS - AI BRAIN EDITOR (Fixed Version)")
              print("=" * 50)
              
              try:
                  # Langkah 1: Download
                  download_video()
                  
                  # Langkah 2: Transkripsi
                  segments = transcribe_video()
                  print(f"üìù Transkripsi selesai: {len(segments)} segmen")
                  
                  # Langkah 3: Analisis AI
                  selected_clips = ai_editorial_decision(segments)
                  
                  # Langkah 4: Potong video
                  if selected_clips:
                      cut_and_save(selected_clips)
                      
                      # Ringkasan
                      print("\n" + "=" * 50)
                      print("üé¨ RINGKASAN OUTPUT:")
                      total_duration = 0
                      for i, clip in enumerate(selected_clips):
                          duration = float(clip["end_time"]) - float(clip["start_time"])
                          total_duration += duration
                          print(f"{i+1}. {clip.get('title', 'Tanpa judul')}")
                          print(f"   ‚è±Ô∏è  {clip['start_time']}s - {clip['end_time']}s ({duration:.1f}s)")
                          print(f"   ‚ù§Ô∏è  Emosi: {clip.get('emotion', 'N/A')}")
                          print()
                      
                      print(f"üì¶ Total {len(selected_clips)} klip ({total_duration:.1f}s)")
                  else:
                      print("‚ö†Ô∏è Tidak ada klip yang dihasilkan oleh AI")
                      
              except Exception as e:
                  print(f"‚ùå ERROR: {str(e)}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
          
          # === ENTRY POINT ===
          if __name__ == "__main__":
              main()
          EOF

      - name: Run AI Pipeline
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
          AI_CREATIVITY: ${{ github.event.inputs.ai_creativity }}
        run: python ai_editor.py

      - name: Zip Results
        run: |
          zip -r viral_shorts_pack.zip output/
          ls -lah output/*.mp4 2>/dev/null || echo "No MP4 files found"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Custom-Shorts-Results
          path: viral_shorts_pack.zip
          retention-days: 7
