name: Build ESP-IDF Toolchains (ARM64 Host) - Final Fixed

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: false

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        target:
          - xtensa-esp32-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean workspace
        run: |
          echo "Membersihkan workspace..."
          rm -rf crosstool-ng crosstool-NG .config* .build x-tools overlays
          mkdir -p x-tools

      - name: Set environment variables
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf automake bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev libncursesw5-dev \
            python3 python3-dev python3-distutils python3-pip \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils lzip gzip curl rsync \
            libgmp-dev libmpfr-dev libmpc-dev libexpat1-dev zlib1g-dev \
            g++ gcc make patch gettext
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true

      - name: Download crosstool-NG fork
        run: |
          echo "Mengunduh crosstool-NG fork Espressif..."
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          
          echo "Memeriksa struktur direktori..."
          cd crosstool-ng
          echo "Arsitektur yang tersedia:"
          ls -la config/arch/ || echo "config/arch tidak ditemukan"
          echo "Samples yang tersedia:"
          ls -la samples/ || echo "samples tidak ditemukan"

      - name: Build and install crosstool-NG
        run: |
          cd $WORKSPACE/crosstool-ng
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          sudo make install
          echo "crosstool-NG version:"
          ct-ng --version || echo "ct-ng not found"

      - name: Setup build directories
        run: |
          mkdir -p $WORKSPACE/.build/tarballs
          mkdir -p $WORKSPACE/.build/src
          echo "CT_LOCAL_TARBALLS_DIR=$WORKSPACE/.build/tarballs" >> $GITHUB_ENV

      - name: Pre-download tarballs
        run: |
          echo "Mengunduh tarball yang diperlukan..."
          mkdir -p $CT_LOCAL_TARBALLS_DIR
          cd $CT_LOCAL_TARBALLS_DIR
          
          # Download essential tarballs
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz || echo "Failed gmp"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz || echo "Failed mpfr"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz || echo "Failed mpc"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/binutils/binutils-2.36.1.tar.xz || echo "Failed binutils"
          wget -q --tries=3 --timeout=60 -c https://ftp.gnu.org/gnu/gcc/gcc-8.4.0/gcc-8.4.0.tar.xz || echo "Failed gcc"
          wget -q --tries=3 --timeout=60 -c https://sourceware.org/pub/newlib/newlib-3.3.0.tar.gz || echo "Failed newlib"
          
          echo "Tarballs tersedia:"
          ls -la *.tar.* 2>/dev/null | wc -l

      - name: Create proper configuration
        run: |
          cd $WORKSPACE/crosstool-ng
          
          echo "=== MEMBUAT KONFIGURASI UNTUK $TARGET ==="
          
          # Reset any existing config
          rm -f .config .config.old
          
          # First, check if we have a sample configuration
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            echo "Menggunakan sample configuration"
            cp samples/$TARGET/crosstool.config .config
          else
            echo "Membuat configuration manual untuk bare-metal ESP32"
            # Create configuration using a heredoc to ensure all lines are added
            cat > .config << 'EOF'
CT_OBSOLETE=y
CT_EXPERIMENTAL=y
CT_ALLOW_BUILD_AS_ROOT=y
CT_ALLOW_BUILD_AS_ROOT_SURE=y
CT_LOG_PROGRESS_BAR=n
CT_KERNEL_NONE=y
CT_KERNEL="none"
CT_LIBC_NEWLIB=y
CT_CC_LANG_CXX=y
CT_DEBUG_GDB=y
CT_CC_GCC=y
CT_BINUTILS=y
CT_GDB=y
CT_PATCH_BUNDLED=y
CT_PATCH_BUNDLED_LOCAL=n
CT_PATCH_LOCAL=n
CT_PATCH_NONE=n
CT_TARGET="xtensa-esp32-elf"
CT_ARCH="xtensa"
CT_ARCH_XTENSA=y
CT_ARCH_XTENSA_CPU="lx6"
CT_ARCH_XTENSA_CORE="custom"
CT_ARCH_XTENSA_CORE="esp32"
CT_HOST="aarch64-unknown-linux-gnu"
CT_PREFIX_DIR="$CT_PREFIX_DIR"
CT_LOCAL_TARBALLS_DIR="$CT_LOCAL_TARBALLS_DIR"
CT_USE_PIPES=y
CT_PARALLEL_JOBS=4
CT_GCC_VERSION="8.4.0"
CT_BINUTILS_VERSION="2.36.1"
CT_GDB_VERSION="9.2"
CT_NEWLIB_VERSION="3.3.0"
CT_SHARED_LIBS=n
CT_THREADS="none"
CT_CC_GCC_USE_LTO=n
EOF
          fi
          
          # Update paths with actual values (replace placeholders)
          sed -i "s|CT_PREFIX_DIR=\"\\$CT_PREFIX_DIR\"|CT_PREFIX_DIR=\"$CT_PREFIX_DIR\"|g" .config
          sed -i "s|CT_LOCAL_TARBALLS_DIR=\"\\$CT_LOCAL_TARBALLS_DIR\"|CT_LOCAL_TARBALLS_DIR=\"$CT_LOCAL_TARBALLS_DIR\"|g" .config
          
          # Update parallel jobs
          sed -i "s|CT_PARALLEL_JOBS=4|CT_PARALLEL_JOBS=$(nproc)|g" .config
          
          # Ensure CT_TARGET is correct
          sed -i "s|CT_TARGET=\".*\"|CT_TARGET=\"$TARGET\"|g" .config
          
          # For specific ESP32 variants
          if [[ "$TARGET" == *"esp32"* ]]; then
            sed -i 's|CT_ARCH_XTENSA_CORE="custom"|CT_ARCH_XTENSA_CORE="esp32"|g' .config
          fi
          
          echo "=== KONFIGURASI YANG DIBUAT ==="
          echo "Isi .config (pertama 30 baris):"
          head -30 .config
          echo ""
          echo "Pemeriksaan CT_KERNEL:"
          grep "CT_KERNEL" .config || echo "CT_KERNEL tidak ditemukan!"

      - name: Verify configuration
        run: |
          cd $WORKSPACE/crosstool-ng
          echo "=== VERIFIKASI KONFIGURASI ==="
          
          # Check if .config exists
          if [ ! -f .config ]; then
            echo "ERROR: .config tidak ditemukan!"
            exit 1
          fi
          
          # Display config for debugging
          echo "Isi .config lengkap:"
          cat .config
          
          # Check critical settings
          echo ""
          echo "Memeriksa pengaturan kritis..."
          
          # List of required settings
          REQUIRED_SETTINGS=(
            "CT_TARGET"
            "CT_ARCH" 
            "CT_HOST"
            "CT_KERNEL"
            "CT_PREFIX_DIR"
            "CT_LOCAL_TARBALLS_DIR"
          )
          
          ALL_OK=true
          for setting in "${REQUIRED_SETTINGS[@]}"; do
            if grep -q "^$setting=" .config; then
              echo "‚úì $setting ditemukan: $(grep "^$setting=" .config)"
            else
              echo "‚úó ERROR: $setting tidak diatur dalam .config!"
              ALL_OK=false
            fi
          done
          
          # Ensure kernel is set to "none" for bare-metal
          if grep -q 'CT_KERNEL="linux"' .config; then
            echo "ERROR: CT_KERNEL harus 'none' bukan 'linux' untuk ESP32!"
            ALL_OK=false
          fi
          
          if [ "$ALL_OK" = false ]; then
            echo "Verifikasi gagal!"
            exit 1
          fi
          
          echo "Konfigurasi valid."

      - name: Build toolchain
        id: build
        run: |
          cd $WORKSPACE/crosstool-ng
          
          echo "=== MEMULAI BUILD ==="
          echo "Target: $TARGET"
          echo "Architecture: $(grep CT_ARCH .config)"
          echo "Kernel: $(grep CT_KERNEL .config)"
          
          # Clean previous build
          ./ct-ng clean 2>/dev/null || true
          rm -rf .build/$TARGET
          
          # Set environment variables
          export CT_NG_BUILD_FORCE=1
          export CT_EXPERIMENTAL=y
          export HOME=$WORKSPACE
          
          # Create build directory
          mkdir -p $WORKSPACE/.build/logs
          
          echo "Menjalankan ct-ng build..."
          echo "Ini mungkin memakan waktu 30-60 menit..."
          
          # Try to build with detailed logging
          set +e
          timeout 7200 ./ct-ng build 2>&1 | tee $WORKSPACE/.build/logs/build.log
          BUILD_STATUS=${PIPESTATUS[0]}
          set -e
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "‚úì BUILD SUKSES"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚úó BUILD GAGAL dengan exit code: $BUILD_STATUS"
            echo "success=false" >> $GITHUB_OUTPUT
            
            # Analyze the error
            echo "=== ANALISIS ERROR ==="
            
            if [ $BUILD_STATUS -eq 124 ]; then
              echo "ERROR: Build timeout setelah 2 jam!"
            fi
            
            echo "--- 50 baris terakhir log ---"
            tail -50 $WORKSPACE/.build/logs/build.log
            
            echo "--- Error lines ---"
            grep -i "error\|Error\|ERROR\|fail\|Fail\|FAIL\|No such file" $WORKSPACE/.build/logs/build.log | tail -20 || true
            
            # Check for specific errors
            if grep -q "kernel/.sh" $WORKSPACE/.build/logs/build.log; then
              echo "ERROR SPESIFIK: Masalah kernel configuration"
              echo "CT_KERNEL saat ini: $(grep CT_KERNEL .config)"
              echo "Ubah CT_KERNEL menjadi 'none' bukan 'linux'"
            fi
            
            if grep -q "arch/.sh" $WORKSPACE/.build/logs/build.log; then
              echo "ERROR SPESIFIK: Masalah arsitektur script"
              echo "CT_ARCH saat ini: $(grep CT_ARCH .config)"
            fi
            
            exit 1
          fi

      - name: Test and package toolchain
        if: steps.build.outputs.success == 'true'
        id: package
        run: |
          echo "=== TEST DAN PACKAGE TOOLCHAIN ==="
          
          # Check if toolchain was built
          if [ -d "$CT_PREFIX_DIR/$TARGET" ]; then
            echo "Toolchain ditemukan di: $CT_PREFIX_DIR/$TARGET"
            echo "Isi direktori:"
            ls -la $CT_PREFIX_DIR/$TARGET/
            echo ""
            echo "Isi bin/:"
            ls -la $CT_PREFIX_DIR/$TARGET/bin/ 2>/dev/null || echo "bin/ tidak ditemukan"
            
            # Check for key binaries
            if [ -f "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" ]; then
              echo "‚úì gcc ditemukan"
              $CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc --version | head -1
            else
              echo "‚úó gcc TIDAK ditemukan"
              echo "Mencari file gcc..."
              find $CT_PREFIX_DIR/$TARGET -name "*gcc*" -type f 2>/dev/null | head -10 || true
            fi
            
            # Check other important tools
            for tool in g++ ar ld objcopy objdump readelf; do
              if [ -f "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-$tool" ]; then
                echo "‚úì $tool ditemukan"
              else
                echo "‚úó $tool tidak ditemukan"
              fi
            done
          else
            echo "‚úó Direktori toolchain tidak ditemukan"
            echo "Isi $CT_PREFIX_DIR:"
            ls -la $CT_PREFIX_DIR/
            echo ""
            echo "Mungkin build gagal meskipun dilaporkan sukses."
            exit 1
          fi
          
          # Create artifact
          mkdir -p $WORKSPACE/artifacts
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARTIFACT_NAME="${TARGET}-${CT_HOST_TRIPLET}-${TIMESTAMP}.tar.gz"
          
          echo "Membuat archive: $ARTIFACT_NAME"
          tar -czf "$WORKSPACE/artifacts/$ARTIFACT_NAME" -C "$CT_PREFIX_DIR" "$TARGET"
          
          # Verify archive
          if [ -f "$WORKSPACE/artifacts/$ARTIFACT_NAME" ]; then
            SIZE=$(du -h "$WORKSPACE/artifacts/$ARTIFACT_NAME" | cut -f1)
            echo "‚úì Archive berhasil dibuat: $ARTIFACT_NAME ($SIZE)"
            
            # Test extraction
            mkdir -p /tmp/test-extract
            tar -xzf "$WORKSPACE/artifacts/$ARTIFACT_NAME" -C /tmp/test-extract
            if [ -f "/tmp/test-extract/$TARGET/bin/$TARGET-gcc" ]; then
              echo "‚úì Archive dapat diekstrak dengan benar"
            else
              echo "‚úó Archive tidak dapat diekstrak dengan benar"
            fi
            rm -rf /tmp/test-extract
            
            echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
            echo "artifact_path=$WORKSPACE/artifacts/$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚úó Gagal membuat archive"
            exit 1
          fi

      - name: Upload artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-toolchain-arm64
          path: ${{ env.WORKSPACE }}/artifacts/
          retention-days: 30

      - name: Upload build logs on failure
        if: steps.build.outputs.success == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.target }}
          path: |
            ${{ env.WORKSPACE }}/.build/logs/
            ${{ env.WORKSPACE }}/crosstool-ng/.config
          retention-days: 30

      - name: Notify success
        if: steps.build.outputs.success == 'true'
        run: |
          echo "========================================"
          echo "üöÄ Toolchain $TARGET berhasil dibangun!"
          echo "üìÅ Lokasi: $CT_PREFIX_DIR/$TARGET"
          echo "üì¶ Archive: ${{ steps.package.outputs.artifact_name || 'N/A' }}"
          echo "========================================"

      - name: Notify failure
        if: steps.build.outputs.success == 'false'
        run: |
          echo "========================================"
          echo "‚ùå Gagal membangun toolchain $TARGET"
          echo "üîß Lihat artifact 'build-logs-${{ matrix.target }}' untuk debugging"
          echo "========================================"