
name: Build ESP32 Toolchain (Android Native - No Proot)

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'

jobs:
  build-native-static:
    # Menggunakan Runner ARM64 (Wajib untuk hasil yang bisa jalan di HP)
    runs-on: ubuntu-22.04-arm
    
    # Menjalankan Job di dalam Container Alpine Linux 3.17
    # Versi 3.17 dipilih karena GCC-nya masih kompatibel dengan source GCC 8.4 lama
    container:
      image: alpine:3.17
      options: --privileged

    timeout-minutes: 360

    steps:
      - name: 1. Install Dependencies Alpine
        run: |
          echo "Installing build dependencies..."
          
          # Update repo dan install paket
          apk update
          
          # PERBAIKAN: List paket yang valid untuk Alpine 3.17
          # Kita gunakan 'gnu-libiconv-dev' pengganti libiconv-dev
          apk add --no-cache \
            build-base git bash autoconf automake bison flex texinfo \
            gawk libtool ncurses-dev ncurses-static python3-dev \
            unzip wget bzip2 xz help2man file rsync patch \
            expat-dev expat-static zlib-dev zlib-static \
            linux-headers gettext-dev gettext-static \
            gnu-libiconv-dev

          # Symlink python agar terdeteksi oleh script configure
          ln -sf /usr/bin/python3 /usr/bin/python
          
          # Cek versi untuk memastikan environment siap
          gcc --version
          echo "Dependencies installed successfully."

      - name: 2. Checkout Repository
        uses: actions/checkout@v4

      - name: 3. Setup Workspace & Permissions
        run: |
          # Fix error git di dalam container
          git config --global --add safe.directory '*'
          
          # Buat folder kerja
          mkdir -p x-tools artifacts .build/tarballs
          
          # Simpan path root
          echo "ROOT_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: 4. Download crosstool-NG
        run: |
          cd $ROOT_DIR
          echo "Cloning crosstool-NG branch: $CROSSTOOL_NG_VERSION"
          git clone https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          
          cd crosstool-NG
          git submodule update --init --recursive
          
          # Bootstrap & Install
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          make install

      - name: 5. Download Manual Library (ISL Fix)
        run: |
          # Download manual library ISL yang sering gagal jika otomatis
          cd $ROOT_DIR/.build/tarballs
          
          echo "Downloading ISL 0.19..."
          wget --tries=5 --waitretry=5 -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2 || \
          wget --tries=5 -O isl-0.19.tar.bz2 https://libisl.sourceforge.io/isl-0.19.tar.bz2

      - name: 6. Konfigurasi Toolchain (Mode Static Musl)
        run: |
          cd $ROOT_DIR/crosstool-NG
          
          TARGET="xtensa-esp32-elf"
          
          # Generate konfigurasi awal
          ./ct-ng $TARGET
          
          # Bersihkan konfigurasi bawaan yang tidak cocok
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_LOG_PROGRESS_BAR/d' .config
          sed -i '/CT_STATIC_TOOLCHAIN/d' .config
          sed -i '/CT_WANTS_STATIC_LINK/d' .config
          
          # INJECT KONFIGURASI KHUSUS ANDROID NATIVE
          cat >> .config <<EOF
          
          # --- PATH SETTINGS ---
          CT_PREFIX_DIR="${ROOT_DIR}/x-tools/${TARGET}"
          CT_LOCAL_TARBALLS_DIR="${ROOT_DIR}/.build/tarballs"
          
          # --- BUILD OPTIONS ---
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_EXPERIMENTAL=y
          CT_LOG_PROGRESS_BAR=n
          CT_PARALLEL_JOBS=$(nproc)
          
          # --- TARGET SPECS ---
          CT_ARCH="xtensa"
          CT_TARGET_VENDOR="esp32"
          CT_ARCH_XTENSA_CORE="esp32"
          CT_OVERLAY_NAME="esp32"
          CT_OVERLAY_LOCATION="${ROOT_DIR}/crosstool-NG/overlays"
          
          # --- STATIC LINKING (RAHASIA AGAR JALAN DI TERMUX) ---
          # Memaksa compiler hasil build menjadi satu file utuh (static)
          # sehingga tidak tergantung pada library sistem Android yg aneh.
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_CC_CX_LDFLAGS="-static"
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y
          
          # --- DISABLE PYTHON GDB ---
          # Python static sangat sulit dibuild, kita matikan agar build sukses.
          CT_GDB_CROSS_PYTHON=n
          CT_GDB_CROSS_PYTHON_BINARY=""
          
          EOF
          
          # Fix Kernel Version (Agar tidak komplain soal versi kernel host)
          if grep -q "CT_KERNEL" .config; then
             sed -i 's/^CT_KERNEL=.*/CT_KERNEL="none"/' .config
          else
             echo 'CT_KERNEL="none"' >> .config
          fi

          # Apply konfigurasi
          yes "" | ./ct-ng oldconfig

      - name: 7. Build Toolchain
        id: build
        run: |
          cd $ROOT_DIR/crosstool-NG
          
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          echo "=== MEMULAI BUILD (Estimasi: 45-60 Menit) ==="
          ./ct-ng build
          
          echo "success=true" >> $GITHUB_OUTPUT

      - name: 8. Verifikasi & Packaging
        if: steps.build.outputs.success == 'true'
        run: |
          TARGET="xtensa-esp32-elf"
          BIN_DIR="$ROOT_DIR/x-tools/$TARGET/bin"
          
          echo "=== VERIFIKASI HASIL BUILD ==="
          
          if [ ! -f "$BIN_DIR/xtensa-esp32-elf-gcc" ]; then
             echo "FATAL: File GCC tidak ditemukan!"
             exit 1
          fi
          
          # Cek apakah benar-benar STATIC
          FILE_INFO=$(file $BIN_DIR/xtensa-esp32-elf-gcc)
          echo "Info File: $FILE_INFO"
          
          if [[ "$FILE_INFO" == *"statically linked"* ]]; then
             echo "✅ SUKSES: Binary bersifat STATIC. Aman untuk Android Native."
          else
             echo "⚠️ PERINGATAN: Binary mungkin tidak static. Cek ulang konfigurasi."
          fi
          
          # Buat nama file artifact
          ARTIFACT_NAME="${TARGET}-gcc8_4_0-android-native-no-proot.tar.gz"
          cd "$ROOT_DIR/x-tools"
          
          echo "Compressing..."
          tar -czf "$ROOT_DIR/artifacts/$ARTIFACT_NAME" $TARGET
          
          echo "ARTIFACT_PATH=$ROOT_DIR/artifacts/$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: 9. Upload Artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-android-native
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30

      - name: 10. Upload Log Error (Jika Gagal)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs
          path: ${{ env.ROOT_DIR }}/crosstool-NG/build.log
          retention-days: 5
