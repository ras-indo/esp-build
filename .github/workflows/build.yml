name: üß† Viral Shorts ‚Äî AI Brain (Fixed Pillow)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Jumlah Klip'
        required: false
        default: '5'
      ai_creativity:
        description: 'Creativity (0.0 - 1.0)'
        required: false
        default: '0.7'

jobs:
  ai-editor-custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Libraries
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg libsm6 libxext6 libgl1

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -q wheel setuptools
          
          # Install Pillow versi 9.5.0 untuk menghindari ANTIALIAS error
          python -m pip install -q "Pillow==9.5.0"
          
          # Dependencies dasar
          python -m pip install -q yt-dlp openai tiktoken
          python -m pip install -q numpy==1.24.0
          python -m pip install -q imageio imageio[ffmpeg]
          
          # LangChain versi stabil
          python -m pip install -q "langchain==0.1.16" "langchain-core==0.1.44" "langchain-openai==0.0.8"
          
          # Whisper
          python -m pip install -q "openai-whisper>=20231117"
          
          # MoviePy
          python -m pip install -q "moviepy==1.0.3" decorator tqdm proglog

      - name: Create AI Editor Script
        run: |
          cat > ai_editor.py << 'EOF'
          import os
          import json
          import subprocess
          import sys
          import whisper
          from pathlib import Path
          
          # === IMPORTS LANGCHAIN ===
          try:
              from langchain_openai import ChatOpenAI
              from langchain_core.prompts import ChatPromptTemplate
              print("‚úÖ LangChain imports berhasil")
          except ImportError as e:
              print(f"‚ùå Error import LangChain: {e}")
              sys.exit(1)
          
          # === IMPORTS MOVIEPY ===
          try:
              from moviepy.editor import VideoFileClip, TextClip, CompositeVideoClip, ColorClip
              from moviepy.video.fx.all import resize
              print("‚úÖ MoviePy imports berhasil")
          except ImportError as e:
              print(f"‚ùå Error import MoviePy: {e}")
              sys.exit(1)
          
          # === KONFIGURASI ===
          CUSTOM_API_KEY = "Kontolondon"
          CUSTOM_BASE_URL = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          TEMPERATURE = float(os.environ.get("AI_CREATIVITY", 0.7))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"
          
          # === 1. DOWNLOAD VIDEO ===
          def download_video():
              print("‚¨áÔ∏è Downloading video...")
              try:
                  subprocess.run([
                      "yt-dlp", VIDEO_URL, 
                      "-o", str(VIDEO_PATH), 
                      "--force-overwrites",
                      "--quiet"
                  ], check=True, stderr=subprocess.DEVNULL)
              except subprocess.CalledProcessError:
                  print("üîÑ yt-dlp gagal, mencoba curl...")
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)], 
                                stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
              
              if VIDEO_PATH.exists() and VIDEO_PATH.stat().st_size > 1000:
                  print(f"‚úÖ Video siap ({VIDEO_PATH.stat().st_size // 1024} KB)")
              else:
                  raise Exception("‚ùå Gagal download video.")
          
          # === 2. WHISPER TRANSCRIPTION ===
          def transcribe_video():
              print("üëÇ Menggunakan Whisper untuk transkripsi...")
              model = whisper.load_model("small")
              result = model.transcribe(
                  str(VIDEO_PATH),
                  language="id",
                  task="transcribe"
              )
              return result["segments"]
          
          # === 3. AI EDITORIAL DECISION ===
          def ai_editorial_decision(segments):
              print("üß† AI Editor menganalisis konten...")
              
              # Format transkrip
              transcript_lines = []
              for seg in segments[:50]:
                  start_min = int(seg['start']) // 60
                  start_sec = int(seg['start']) % 60
                  text = seg['text'].strip()
                  transcript_lines.append(f"[{start_min:02d}:{start_sec:02d}] {text}")
              
              transcript_text = "\n".join(transcript_lines)
              
              # Inisialisasi LLM
              llm = ChatOpenAI(
                  temperature=TEMPERATURE,
                  model="gpt-4",
                  openai_api_key=CUSTOM_API_KEY,
                  openai_api_base=CUSTOM_BASE_URL,
                  max_tokens=2000
              )
              
              # Prompt template
              prompt_template = """
              Kamu adalah Editor Video Professional untuk konten Shorts/TikTok/Reels.
              
              TUGAS: Pilih {num_clips} klip terbaik dari transkrip video berikut.
              
              KRITERIA KLIP VIRAL:
              1. Hook kuat di 3 detik pertama
              2. Cerita yang koheren dan lengkap
              3. Emosi yang kuat (lucu, mengejutkan, informatif, atau mengharukan)
              4. Durasi ideal: 15-60 detik
              5. Hindari bagian intro/outro yang membosankan
              
              OUTPUT FORMAT (JSON):
              {{
                "clips": [
                  {{
                    "start_time": 10.5,
                    "end_time": 45.2,
                    "title": "Judul klip 1",
                    "viral_reasoning": "Alasan kenapa klip ini viral",
                    "emotion": "funny"
                  }}
                ]
              }}
              
              INSTRUKSI:
              - start_time dan end_time dalam detik (angka desimal)
              - Durasi minimal 15 detik, maksimal 90 detik
              - Emotion: funny, surprising, informative, emotional, neutral
              - Jumlah klip: {num_clips}
              
              TRANSCRIPT:
              {transcript}
              
              Hanya kembalikan JSON, tidak ada teks lain.
              """
              
              prompt = ChatPromptTemplate.from_template(prompt_template)
              
              messages = prompt.format_messages(
                  num_clips=NUM_CLIPS,
                  transcript=transcript_text[:8000]
              )
              
              try:
                  print("üîÑ Memproses dengan AI...")
                  response = llm.invoke(messages)
                  content = response.content.strip()
                  
                  # Bersihkan response
                  if "```json" in content:
                      content = content.split("```json")[1].split("```")[0].strip()
                  elif "```" in content:
                      content = content.split("```")[1].split("```")[0].strip()
                  
                  # Parse JSON
                  import json as json_module
                  parsed_data = json_module.loads(content)
                  clips = parsed_data.get("clips", [])
                  
                  # Validasi klip
                  valid_clips = []
                  for clip in clips:
                      if not all(key in clip for key in ["start_time", "end_time", "title", "viral_reasoning", "emotion"]):
                          continue
                          
                      try:
                          start = float(clip["start_time"])
                          end = float(clip["end_time"])
                          duration = end - start
                          
                          if 15 <= duration <= 90:
                              valid_clips.append(clip)
                          else:
                              print(f"‚ö†Ô∏è Klip dibuang: durasi {duration:.1f}s")
                      except ValueError:
                          continue
                  
                  print(f"‚úÖ Ditemukan {len(valid_clips)} klip valid")
                  return valid_clips
                  
              except Exception as e:
                  print(f"‚ùå Error AI: {str(e)}")
                  if 'response' in locals():
                      print(f"Response: {response.content[:200]}")
                  return []
          
          # === 4. VIDEO CUTTING DENGAN MOVIEPY ===
          def cut_and_save(clips_data):
              print("‚úÇÔ∏è Memotong video dengan MoviePy...")
              
              if not clips_data:
                  print("‚ö†Ô∏è Tidak ada klip untuk dipotong")
                  return
              
              try:
                  source_video = VideoFileClip(str(VIDEO_PATH))
                  print(f"üìπ Video loaded: {source_video.duration:.1f}s, {source_video.size}")
              except Exception as e:
                  print(f"‚ùå Gagal load video: {e}")
                  return
              
              for idx, clip in enumerate(clips_data):
                  try:
                      start = float(clip["start_time"])
                      end = float(clip["end_time"])
                      
                      # Validasi waktu
                      if start >= end:
                          print(f"‚ö†Ô∏è Klip {idx+1}: start >= end, dilewati")
                          continue
                          
                      if start > source_video.duration:
                          print(f"‚ö†Ô∏è Klip {idx+1}: start melebihi durasi video")
                          continue
                          
                      # Adjust end time jika perlu
                      if end > source_video.duration:
                          end = source_video.duration
                          
                      duration = end - start
                      
                      if duration < 5:
                          print(f"‚ö†Ô∏è Klip {idx+1}: terlalu pendek ({duration:.1f}s)")
                          continue
                      
                      # Nama file
                      emotion = clip.get("emotion", "neutral")
                      filename = f"short_{idx+1:02d}_{emotion}.mp4"
                      out_path = OUTDIR / filename
                      json_path = OUTDIR / f"short_{idx+1:02d}_meta.json"
                      
                      print(f"üîÑ Processing klip {idx+1}: {start:.1f}s - {end:.1f}s ({duration:.1f}s)")
                      
                      # Potong video
                      subclip = source_video.subclip(start, end)
                      
                      # Fungsi resize dengan monkey patch untuk ANTIALIAS
                      def resize_with_fallback(clip, width=None, height=None):
                          """Resize function with fallback for ANTIALIAS error"""
                          try:
                              # Coba resize biasa dulu
                              from moviepy.video.fx.all import resize as moviepy_resize
                              return moviepy_resize(clip, width=width, height=height)
                          except AttributeError as e:
                              if "ANTIALIAS" in str(e):
                                  print("‚ö†Ô∏è ANTIALIAS error, menggunakan resize manual...")
                                  # Gunakan resize manual tanpa ANTIALIAS
                                  from PIL import Image
                                  import numpy as np
                                  
                                  def resize_frame(frame):
                                      # Convert numpy array to PIL Image
                                      pil_img = Image.fromarray(frame)
                                      
                                      # Calculate new size
                                      original_width, original_height = pil_img.size
                                      
                                      if width and height:
                                          new_size = (width, height)
                                      elif width:
                                          ratio = width / original_width
                                          new_size = (width, int(original_height * ratio))
                                      elif height:
                                          ratio = height / original_height
                                          new_size = (int(original_width * ratio), height)
                                      else:
                                          return frame
                                      
                                      # Resize with LANCZOS (replacement for ANTIALIAS)
                                      resized_img = pil_img.resize(new_size, Image.Resampling.LANCZOS)
                                      
                                      # Convert back to numpy array
                                      return np.array(resized_img)
                                  
                                  # Apply resize to each frame
                                  return clip.fl_image(resize_frame)
                              else:
                                  raise e
                      
                      # Konversi ke vertikal (1080x1920) - SEDERHANA
                      def convert_to_vertical(clip):
                          w, h = clip.size
                          target_w, target_h = 1080, 1920
                          
                          # Calculate scale factor to fit height
                          scale = target_h / h
                          new_w = int(w * scale)
                          new_h = target_h
                          
                          # Resize
                          resized = resize_with_fallback(clip, width=new_w, height=new_h)
                          
                          # Jika terlalu lebar, crop tengah
                          if new_w > target_w:
                              x_center = (new_w - target_w) // 2
                              return resized.crop(x1=x_center, y1=0, x2=x_center + target_w, y2=target_h)
                          else:
                              # Tambah background hitam di samping
                              background = ColorClip(
                                  size=(target_w, target_h),
                                  color=(0, 0, 0),
                                  duration=clip.duration
                              )
                              
                              x_pos = (target_w - new_w) // 2
                              final = CompositeVideoClip([
                                  background,
                                  resized.set_position((x_pos, 0))
                              ])
                              return final
                      
                      # Konversi ke format vertikal
                      vertical_clip = convert_to_vertical(subclip)
                      
                      # Export video
                      print(f"üíæ Saving {filename}...")
                      vertical_clip.write_videofile(
                          str(out_path),
                          codec='libx264',
                          audio_codec='aac',
                          fps=30,
                          preset='fast',
                          audio_bitrate='128k',
                          threads=4,
                          logger=None,
                          verbose=False
                      )
                      
                      # Cleanup
                      vertical_clip.close()
                      subclip.close()
                      
                      # Simpan metadata
                      metadata = {
                          "filename": filename,
                          "title": clip.get("title", f"Klip {idx+1}"),
                          "reasoning": clip.get("viral_reasoning", ""),
                          "emotion": emotion,
                          "timing": {"start": start, "end": end, "duration": duration},
                          "resolution": "1080x1920"
                      }
                      
                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(metadata, f, indent=2, ensure_ascii=False)
                      
                      print(f"‚úÖ {filename} ({duration:.1f}s)")
                      
                  except Exception as ex:
                      print(f"‚ùå Error klip {idx+1}: {str(ex)}")
                      import traceback
                      traceback.print_exc()
              
              # Cleanup
              source_video.close()
          
          # === 5. MAIN EXECUTION ===
          def main():
              print("=" * 50)
              print("üß† VIRAL SHORTS - AI BRAIN EDITOR")
              print("=" * 50)
              
              try:
                  # Langkah 1: Download
                  download_video()
                  
                  # Langkah 2: Transkripsi
                  segments = transcribe_video()
                  print(f"üìù Transkripsi selesai: {len(segments)} segmen")
                  
                  # Langkah 3: Analisis AI
                  selected_clips = ai_editorial_decision(segments)
                  
                  # Langkah 4: Potong video
                  if selected_clips:
                      cut_and_save(selected_clips)
                      
                      # Ringkasan
                      print("\n" + "=" * 50)
                      print("üé¨ RINGKASAN OUTPUT:")
                      total_duration = 0
                      for i, clip in enumerate(selected_clips):
                          duration = float(clip["end_time"]) - float(clip["start_time"])
                          total_duration += duration
                          print(f"{i+1}. {clip.get('title', 'Tanpa judul')}")
                          print(f"   ‚è±Ô∏è  {clip['start_time']}s - {clip['end_time']}s ({duration:.1f}s)")
                          print(f"   ‚ù§Ô∏è  Emosi: {clip.get('emotion', 'N/A')}")
                          print()
                      
                      print(f"üì¶ Total {len(selected_clips)} klip ({total_duration:.1f}s)")
                      print(f"üìÅ Output di: {OUTDIR.absolute()}")
                      
                      # List files yang berhasil dibuat
                      output_files = list(OUTDIR.glob("*.mp4"))
                      if output_files:
                          print("\nüìÇ File yang dihasilkan:")
                          for f in output_files:
                              size_mb = f.stat().st_size / (1024*1024)
                              print(f"   ‚Ä¢ {f.name} ({size_mb:.1f} MB)")
                  else:
                      print("‚ö†Ô∏è Tidak ada klip yang dihasilkan")
                      
              except Exception as e:
                  print(f"‚ùå ERROR: {str(e)}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
          
          # === ENTRY POINT ===
          if __name__ == "__main__":
              main()
          EOF

      - name: Run AI Pipeline
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
          AI_CREATIVITY: ${{ github.event.inputs.ai_creativity }}
        run: |
          # Verifikasi versi dependencies
          python -c "import PIL; print(f'Pillow version: {PIL.__version__}')"
          python -c "import moviepy; print(f'MoviePy version: {moviepy.__version__}')"
          python ai_editor.py

      - name: Zip Results
        run: |
          zip -r viral_shorts_pack.zip output/
          echo "=== File dalam output/ ==="
          find output/ -type f -name "*.mp4" -o -name "*.json" | sort

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AI-Custom-Shorts-Results
          path: viral_shorts_pack.zip
          retention-days: 7
