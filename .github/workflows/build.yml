name: Build ESP-IDF Toolchains (ARM64 Host) - Fixed

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-2021r2'
  CT_HOST_TRIPLET: 'aarch64-unknown-linux-gnu'

jobs:
  compile:
    runs-on: ubuntu-22.04-arm
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean workspace dari konfigurasi lama
        run: |
          echo "Membersihkan workspace dari konfigurasi lama..."
          rm -rf crosstool-ng crosstool-NG .config* x-tools overlays .build
          mkdir -p x-tools

      - name: Set environment variables
        run: |
          echo "TARGET=${{ matrix.target }}" >> $GITHUB_ENV
          echo "CT_PREFIX_DIR=$GITHUB_WORKSPACE/x-tools" >> $GITHUB_ENV
          echo "CT_HOST_TRIPLET=${{ env.CT_HOST_TRIPLET }}" >> $GITHUB_ENV
          echo "CROSSTOOL_NG_VERSION=${{ env.CROSSTOOL_NG_VERSION }}" >> $GITHUB_ENV
          echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Install dependencies build
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential autoconf bison flex texinfo help2man gawk \
            libtool libtool-bin libncurses5-dev libncursesw5-dev \
            python3 python3-dev python3-distutils python3-pip \
            git wget unzip pkg-config ca-certificates gperf ninja-build cmake \
            file bzip2 xz-utils lzip gzip curl rsync \
            libgmp-dev libmpfr-dev libmpc-dev
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true
          sudo pip3 install --upgrade pip

      - name: Download dan setup crosstool-NG (Fork Espressif)
        run: |
          echo "Mengunduh crosstool-NG fork Espressif..."
          git clone --depth=1 https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          mv crosstool-NG crosstool-ng
          echo "Fork Espressif $CROSSTOOL_NG_VERSION siap"
          
          # Verifikasi clone
          cd crosstool-ng
          git log -1 --oneline
          echo "Samples yang tersedia:"
          ls samples/ | grep -i esp || echo "Tidak ada sample ESP"

      - name: Build dan install crosstool-NG
        run: |
          cd crosstool-ng
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          sudo make install
          echo "crosstool-NG terinstall"
          ct-ng --version

      - name: Setup workspace untuk build toolchain
        run: |
          echo "Setup workspace..."
          mkdir -p $WORKSPACE/.build/tarballs
          mkdir -p $WORKSPACE/.build/src
          mkdir -p $WORKSPACE/.build/logs
          
          # Set environment variables untuk ct-ng
          echo "CT_LOCAL_TARBALLS_DIR=$WORKSPACE/.build/tarballs" >> $GITHUB_ENV
          echo "CT_WORK_DIR=$WORKSPACE/.build" >> $GITHUB_ENV

      - name: Pre-download tarball yang diperlukan
        run: |
          echo "PRE-DOWNLOAD TARBALL KE CACHE LOKAL..."
          mkdir -p $WORKSPACE/.build/tarballs
          cd $WORKSPACE/.build/tarballs
          
          # Download tarball yang umum digunakan
          TARBALLS=(
            "https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz"
            "https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz"
            "https://ftp.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz"
            "https://ftp.gnu.org/gnu/binutils/binutils-2.36.1.tar.xz"
            "https://ftp.gnu.org/gnu/gcc/gcc-8.4.0/gcc-8.4.0.tar.xz"
            "https://sourceware.org/pub/newlib/newlib-3.3.0.tar.gz"
            "https://ftp.gnu.org/gnu/gdb/gdb-9.2.tar.xz"
          )
          
          for url in "${TARBALLS[@]}"; do
            filename=$(basename "$url")
            echo "Downloading $filename..."
            wget -q --tries=3 --timeout=120 -c "$url" || echo "Failed to download $filename"
          done
          
          echo "Tarball yang tersedia:"
          ls -la *.tar.* 2>/dev/null | wc -l

      - name: Konfigurasi toolchain menggunakan sample ESP
        run: |
          cd $WORKSPACE/crosstool-ng
          
          echo "=== MENGGUNAKAN SAMPLE KONFIGURASI ESP ==="
          
          # Cek apakah sample untuk target kita ada
          if [ -f "samples/$TARGET/crosstool.config" ]; then
            echo "Menggunakan sample konfigurasi dari crosstool-NG untuk $TARGET"
            cp samples/$TARGET/crosstool.config .config
          else
            echo "Sample untuk $TARGET tidak ditemukan, menggunakan ct-ng untuk generate"
            ./ct-ng $TARGET
          fi
          
          # Pastikan konfigurasi ada
          if [ ! -f .config ]; then
            echo "ERROR: Konfigurasi tidak berhasil dibuat!"
            exit 1
          fi
          
          # Update konfigurasi dengan path yang benar
          echo "Memperbarui konfigurasi..."
          sed -i "s|CT_PREFIX_DIR=.*|CT_PREFIX_DIR=\"$CT_PREFIX_DIR\"|" .config
          sed -i "s|CT_LOCAL_TARBALLS_DIR=.*|CT_LOCAL_TARBALLS_DIR=\"$CT_LOCAL_TARBALLS_DIR\"|" .config
          
          # Enable experimental features untuk build yang lebih baru
          echo "CT_EXPERIMENTAL=y" >> .config
          echo "CT_ALLOW_BUILD_AS_ROOT=y" >> .config
          echo "CT_ALLOW_BUILD_AS_ROOT_SURE=y" >> .config
          
          echo "=== KONFIGURASI FINAL ==="
          echo "CT_TARGET: $(grep 'CT_TARGET=' .config)"
          echo "CT_PREFIX_DIR: $(grep 'CT_PREFIX_DIR=' .config)"
          echo "CT_LOCAL_TARBALLS_DIR: $(grep 'CT_LOCAL_TARBALLS_DIR=' .config)"

      - name: Tampilkan konfigurasi yang akan digunakan
        run: |
          cd $WORKSPACE/crosstool-ng
          echo "=== SHOW-CONFIG ==="
          ./ct-ng show-config 2>&1 | head -50
          
          echo "=== INFORMASI TARGET ==="
          ./ct-ng show-config 2>&1 | grep -i "target\|arch\|host" || true

      - name: Build toolchain dengan ct-ng
        id: build
        run: |
          cd $WORKSPACE/crosstool-ng
          
          echo "=== MEMULAI BUILD TOOLCHAIN ==="
          echo "Target: $TARGET"
          echo "Host: $CT_HOST_TRIPLET"
          echo "Prefix: $CT_PREFIX_DIR"
          
          # Set environment untuk build
          export CT_NG_BUILD_FORCE=1
          export CT_EXPERIMENTAL=y
          export HOME=$WORKSPACE
          
          # Bersihkan build sebelumnya
          ./ct-ng clean
          
          # Mulai build
          echo "Membangun toolchain..."
          set +e
          time ./ct-ng build 2>&1 | tee $WORKSPACE/build.log
          BUILD_STATUS=$?
          set -e
          
          if [ $BUILD_STATUS -eq 0 ]; then
            echo "âœ“âœ“âœ“ BUILD SUKSES! âœ“âœ“âœ“"
            echo "success=true" >> $GITHUB_OUTPUT
            
            # Verifikasi toolchain
            if [ -f "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" ]; then
              echo "Toolchain ditemukan di: $CT_PREFIX_DIR/$TARGET/bin/"
              "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc" --version
            fi
          else
            echo "âœ—âœ—âœ— BUILD GAGAL âœ—âœ—âœ—"
            echo "success=false" >> $GITHUB_OUTPUT
            
            # Analisis error
            echo "=== ANALISIS ERROR ==="
            tail -100 $WORKSPACE/build.log | grep -i "error\|fail\|warning" || true
            
            # Simpan log lengkap untuk debugging
            mkdir -p $WORKSPACE/error-logs
            cp $WORKSPACE/build.log $WORKSPACE/error-logs/build-$TARGET.log
            cp .config $WORKSPACE/error-logs/config-$TARGET.txt
            
            exit 1
          fi

      - name: Package toolchain
        if: steps.build.outputs.success == 'true'
        id: package
        run: |
          echo "Packaging toolchain $TARGET..."
          
          # Verifikasi semua file penting
          REQUIRED_FILES=(
            "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-gcc"
            "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-g++"
            "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-ar"
            "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-ld"
            "$CT_PREFIX_DIR/$TARGET/bin/$TARGET-objcopy"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ $file"
            else
              echo "âœ— $file - TIDAK DITEMUKAN"
            fi
          done
          
          # Buat archive
          mkdir -p $WORKSPACE/artifacts
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_NAME="${TARGET}-${CT_HOST_TRIPLET}-${TIMESTAMP}.tar.gz"
          
          echo "Membuat archive: $ARCHIVE_NAME"
          tar -czf "$WORKSPACE/artifacts/$ARCHIVE_NAME" \
            -C "$CT_PREFIX_DIR" \
            "$TARGET"
          
          # Hitung ukuran
          SIZE=$(du -h "$WORKSPACE/artifacts/$ARCHIVE_NAME" | cut -f1)
          echo "Archive size: $SIZE"
          
          echo "asset_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "asset_path=$WORKSPACE/artifacts/$ARCHIVE_NAME" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-arm64-toolchain
          path: ${{ steps.package.outputs.asset_path }}
          retention-days: 30

      - name: Upload error logs
        if: steps.build.outputs.success == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ matrix.target }}
          path: ${{ env.WORKSPACE }}/error-logs/
          retention-days: 30

      - name: Notify success
        if: steps.build.outputs.success == 'true'
        run: |
          echo "========================================"
          echo "ğŸš€ Toolchain $TARGET berhasil dibangun!"
          echo "ğŸ“ Lokasi: $CT_PREFIX_DIR/$TARGET"
          echo "ğŸ“¦ Archive: ${{ steps.package.outputs.asset_name }}"
          echo "========================================"

      - name: Notify failure
        if: steps.build.outputs.success == 'false'
        run: |
          echo "========================================"
          echo "âŒ Gagal membangun toolchain $TARGET"
          echo "ğŸ”§ Lihat error-logs untuk debugging"
          echo "========================================"