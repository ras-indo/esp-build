name: Build All ESP32 Toolchains (Final V7 - Alpine Fix)

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag Rilis (Kosongkan untuk Auto Date)"
        required: false
        default: ""

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: "esp-13.2.0_20240530"

jobs:
  # --- JOB 1: SIAPKAN RELEASE ---
  prepare_release:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.set_tag.outputs.release_tag }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Tentukan Tag Rilis
        id: set_tag
        env:
          INPUT_TAG: ${{ github.event.inputs.release_tag }}
        run: |
          if [ -n "$INPUT_TAG" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="v$(date +'%Y%m%d-%H%M')"
          fi
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT

      - name: Buat Release di GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.set_tag.outputs.release_tag }}
        run: |
          gh release delete "$TAG" --yes --cleanup-tag || true
          gh release create "$TAG" \
            --title "ESP32 Toolchains (Android Native) - $TAG" \
            --notes "Build Ultimate V7. Support: ESP32, S2, S3, C3, C6, H2. Static Musl." \
            --draft=false \
            --prerelease=false

  # --- JOB 2: BUILD PARALEL (MATRIX) ---
  build_toolchains:
    needs: prepare_release
    runs-on: ubuntu-22.04-arm
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        target:
          - xtensa-esp32-elf
          - xtensa-esp32s2-elf
          - xtensa-esp32s3-elf
          - riscv32-esp-elf

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Generate Build Script
        run: |
          # PERBAIKAN 1: Gunakan /bin/sh untuk script utama
          cat > build_script.sh << 'EOF'
          #!/bin/sh
          set -e
          
          # Config
          TARGET_ARCH="${TARGET_ARG}"
          CT_VERSION="${VERSION_ARG}"
          ROOT_DIR="/workspace"
          
          echo "=== [ALPINE] Building: $TARGET_ARCH ==="
          
          # 1. Install Dependencies (Termasuk BASH untuk fake rsync nanti)
          apk update
          apk add --no-cache \
            build-base git bash autoconf automake bison flex texinfo \
            gawk libtool ncurses-dev ncurses-static python3-dev \
            unzip wget bzip2 xz help2man file patch tar \
            expat-dev expat-static zlib-dev zlib-static \
            linux-headers gettext-dev gettext-static \
            gnu-libiconv-dev mpfr-dev gmp-dev mpc1-dev

          ln -sf /usr/bin/python3 /usr/bin/python
          git config --global --add safe.directory '*'

          # --- TEKNIK SABOTASE RSYNC (PENTING!) ---
          # Kita buat 'fake rsync' menggunakan BASH (karena butuh fitur array slicing)
          # Bash sudah diinstall di langkah atas, jadi aman.
          
          echo "Creating Fake Rsync..."
          cat > /usr/bin/rsync << 'REOF'
          #!/bin/bash
          # Ambil 2 argumen terakhir (Source dan Destination)
          last_arg="${!#}"
          second_last_arg="${@: -2:1}"
          
          # Bersihkan trailing slash
          src="${second_last_arg%/}"
          dst="${last_arg%/}"
          
          echo "FAKERSYNC: Copying $src to $dst"
          cp -rf "$src/." "$dst/"
          REOF
          
          chmod +x /usr/bin/rsync
          # ----------------------------------------

          # 2. Setup & Clone
          mkdir -p $ROOT_DIR/x-tools $ROOT_DIR/artifacts $ROOT_DIR/.build/tarballs
          cd $ROOT_DIR
          
          git clone https://github.com/espressif/crosstool-NG.git -b $CT_VERSION crosstool-NG
          cd crosstool-NG
          git submodule update --init --recursive
          
          # --- STRATEGI BRUTE FORCE OVERLAY ---
          # Copy folder ke semua kemungkinan nama agar pasti ketemu
          cd overlays
          echo "Applying Overlay Duplication..."
          for chip in esp32 esp32s2 esp32s3; do
             ORIGIN="xtensa_$chip"
             if [ -d "$ORIGIN" ]; then
                cp -r "$ORIGIN" "xtensa_$ORIGIN"
                cp -r "$ORIGIN" "$chip"
             fi
          done
          cd ..
          
          ./bootstrap
          ./configure --enable-local --prefix=/usr/local
          make -j$(nproc)
          make install
          
          # 3. Configure Target (Load Sample)
          ./ct-ng $TARGET_ARCH
          
          # Clean Configs
          sed -i '/CT_PREFIX_DIR/d' .config
          sed -i '/CT_LOCAL_TARBALLS_DIR/d' .config
          sed -i '/CT_OVERLAY_LOCATION/d' .config
          sed -i '/CT_LOG_PROGRESS_BAR/d' .config
          sed -i '/CT_STATIC_TOOLCHAIN/d' .config
          sed -i '/CT_WANTS_STATIC_LINK/d' .config
          sed -i '/CT_CC_CX_LDFLAGS/d' .config
          sed -i '/CT_LDFLAGS_FOR_HOST/d' .config

          # Inject Config
          cat >> .config <<CONFIG_EOF
          CT_PREFIX_DIR="${ROOT_DIR}/x-tools/${TARGET_ARCH}"
          CT_LOCAL_TARBALLS_DIR="${ROOT_DIR}/.build/tarballs"
          # Arahkan ke folder overlay yang sudah kita brute-force isinya
          CT_OVERLAY_LOCATION="${ROOT_DIR}/crosstool-NG/overlays"
          
          # Static Build Settings
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_CC_CX_LDFLAGS="-static"
          CT_LDFLAGS_FOR_HOST="-static"
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y
          
          # General Settings
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_EXPERIMENTAL=y
          CT_LOG_PROGRESS_BAR=n
          CT_PARALLEL_JOBS=$(nproc)
          
          # Disable Python
          CT_GDB_CROSS_PYTHON=n
          CT_GDB_CROSS_PYTHON_BINARY=""
          CT_KERNEL="none"
          CONFIG_EOF

          yes "" | ./ct-ng oldconfig
          
          # 4. Build
          echo "Starting Build..."
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          unset CFLAGS CXXFLAGS LDFLAGS
          
          ./ct-ng build
          
          # 5. Packaging
          cd $ROOT_DIR/x-tools
          TAR_NAME="${TARGET_ARCH}-android-native.tar.gz"
          tar --hard-dereference -czf $ROOT_DIR/artifacts/$TAR_NAME ${TARGET_ARCH}
          
          cd $ROOT_DIR/artifacts
          sha256sum $TAR_NAME > ${TAR_NAME}.sha256
          EOF
          
          chmod +x build_script.sh

      - name: Run Build in Docker (Alpine 3.18)
        run: |
          # PERBAIKAN 2: Gunakan /bin/sh untuk memanggil script (Alpine default)
          docker run --rm --privileged \
            -v "${{ github.workspace }}:/workspace" \
            -w "/workspace" \
            -e TARGET_ARG="${{ matrix.target }}" \
            -e VERSION_ARG="${{ env.CROSSTOOL_NG_VERSION }}" \
            alpine:3.18 \
            /bin/sh /workspace/build_script.sh

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare_release.outputs.release_tag }}
        run: |
          echo "Mengupload ke release: $TAG"
          cd artifacts
          gh release upload "$TAG" \
            ${{ matrix.target }}-android-native.tar.gz \
            ${{ matrix.target }}-android-native.tar.gz.sha256 \
            --clobber
