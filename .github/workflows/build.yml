name: Build ESP32 All Variants Native Android (V4 - Total Static)

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

permissions:
  contents: write

env:
  CROSSTOOL_NG_VERSION: 'esp-15.2.0_20251204'

jobs:
  build-native-nuclear:
    # Menggunakan ubuntu-22.04 standar (x64) agar lebih stabil
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        target: 
          - { name: 'xtensa-esp32-elf', arch: 'xtensa', vendor: 'esp32', core: 'esp32', overlay: 'esp32' }
          - { name: 'xtensa-esp32s2-elf', arch: 'xtensa', vendor: 'esp32s2', core: 'esp32s2', overlay: 'esp32s2' }
          - { name: 'xtensa-esp32s3-elf', arch: 'xtensa', vendor: 'esp32s3', core: 'esp32s3', overlay: 'esp32s3' }
          - { name: 'riscv32-esp-elf', arch: 'riscv', vendor: 'esp', core: '', overlay: 'esp32' }

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Tarballs
        uses: actions/cache@v4
        with:
          key: tarballs-${{ env.CROSSTOOL_NG_VERSION }}-${{ matrix.target.name }}
          path: .build/tarballs
          restore-keys: tarballs-${{ env.CROSSTOOL_NG_VERSION }}

      - name: 2. Buat Script Build (Nuclear Static - Fixed Kernel)
        run: |
          cat > build_script.sh << 'EOF'
          #!/bin/sh
          set -e
          
          echo "=== [ALPINE] Setup Dependencies ==="
          apk update
          apk add --no-cache \
            build-base git bash autoconf automake bison flex texinfo \
            gawk libtool ncurses-dev ncurses-static python3-dev \
            unzip wget bzip2 xz help2man file rsync patch \
            expat-dev expat-static zlib-dev zlib-static \
            linux-headers gettext-dev gettext-static \
            gnu-libiconv-dev tar

          ln -sf /usr/bin/python3 /usr/bin/python
          
          export ROOT_DIR=$(pwd)
          export CROSSTOOL_NG_VERSION="${CROSSTOOL_NG_VERSION_ARG}"
          export TARGET="${TARGET_ARG}"
          export ARCH="${ARCH_ARG}"
          export VENDOR="${VENDOR_ARG}"
          export CORE="${CORE_ARG}"
          export OVERLAY="${OVERLAY_ARG}"
          git config --global --add safe.directory '*'

          echo "=== [ALPINE] Clean & Clone ==="
          rm -rf crosstool-NG x-tools artifacts
          mkdir -p x-tools artifacts .build/tarballs
          
          git clone https://github.com/espressif/crosstool-NG.git -b $CROSSTOOL_NG_VERSION
          cd crosstool-NG
          git submodule update --init --recursive
          
          ./bootstrap
          ./configure --enable-local
          make -j$(nproc)
          cd ..

          echo "=== [ALPINE] Download ISL ==="
          cd .build/tarballs
          if [ ! -f isl-0.19.tar.bz2 ]; then
            wget --tries=5 --waitretry=5 -O isl-0.19.tar.bz2 https://sources.easybuild.io/i/ISL/isl-0.19.tar.bz2 || \
            wget --tries=5 -O isl-0.19.tar.bz2 https://libisl.sourceforge.io/isl-0.19.tar.bz2
          fi
          cd ../..

          echo "=== [ALPINE] Configure Toolchain ==="
          cd crosstool-NG
          
          # Hapus config lama
          rm -f .config
          
          # === KONFIGURASI MANUAL (NUCLEAR) ===
          if [ "${ARCH}" = "xtensa" ]; then
            echo "=== Configuring Xtensa target: ${TARGET} ==="
            cat > .config <<CONFIG_EOF
          # CONFIGURATION FOR XTENSA
          CT_OBSOLETE=y
          CT_EXPERIMENTAL=y
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_LOG_LEVEL_MAX="INFO"
          CT_LOG_PROGRESS_BAR=n
          CT_LOG_TO_FILE=y
          CT_LOG_FILE_COMPRESS=y
          CT_LOCAL_TARBALLS_DIR="${ROOT_DIR}/.build/tarballs"
          CT_SAVE_TARBALLS=y
          CT_OVERLAY_LOCATION="${ROOT_DIR}/crosstool-NG/overlays"
          CT_PREFIX_DIR="${ROOT_DIR}/x-tools/${TARGET}"
          CT_PARALLEL_JOBS=$(nproc)
          CT_USE_PIPES=y
          CT_LOAD=""
          
          # --- ARCHITECTURE: XTENSA ---
          CT_ARCH="xtensa"
          CT_ARCH_XTENSA=y
          CT_ARCH_XTENSA_CORE="${CORE}"
          CT_ARCH_SUFFIX=""
          
          # --- KERNEL: BARE METAL (FIXED) ---
          CT_BARE_METAL=y
          CT_KERNEL="bare-metal"
          CT_KERNEL_bare_metal=y
          
          # --- TOOLCHAIN OPTIONS ---
          CT_TARGET_VENDOR="${VENDOR}"
          CT_TARGET_SYS="elf"
          CT_CC_LANG_CXX=y
          CT_LIBC="newlib"
          CT_LIBC_NEWLIB=y
          CT_LIBC_VERSION="4.3.0.20230120"
          CT_LIBC_NEWLIB_IO_FLOAT=y
          CT_LIBC_NEWLIB_EXTRA_SECTIONS=y
          CT_LIBC_NEWLIB_NANO_FORMATTED_IO=y
          CT_BINUTILS="y"
          CT_BINUTILS_VERSION="2.41"
          CT_GCC="y"
          CT_GCC_VERSION="15.2.0"
          CT_GCC_LANGUAGES="c,c++"
          
          # --- DISABLE TEST SUITE (Prevents Segfault) ---
          CT_TEST_SUITE_GCC=n
          
          # --- LIBRARIES ---
          CT_GMP="y"
          CT_GMP_VERSION="6.3.0"
          CT_MPFR="y"
          CT_MPFR_VERSION="4.2.1"
          CT_MPC="y"
          CT_MPC_VERSION="1.3.1"
          CT_ISL="y"
          CT_ISL_VERSION="0.19"
          CT_ZLIB="y"
          CT_ZLIB_VERSION="1.3.1"
          CT_ZSTD="y"
          CT_ZSTD_VERSION="1.5.6"
          CT_GDB="y"
          CT_GDB_VERSION="13.2"
          
          # --- OVERLAYS ---
          CT_OVERLAY_NAME="${OVERLAY}"
          CT_OVERLAY_BUNDLED=y
          CT_OVERLAY_DOWNLOAD=y
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y

          # --- STATIC BUILD (NUCLEAR) ---
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_CC_CX_LDFLAGS="-static -Wl,-Bstatic"
          CT_LDFLAGS_FOR_HOST="-static -Wl,-Bstatic"
          CT_CC_STATIC_LIBSTDCXX=y
          CT_CC_STATIC_LIBGCC=y
          CT_STATIC_LIBS=y
          CONFIG_EOF

          elif [ "${ARCH}" = "riscv" ]; then
            echo "=== Configuring RISC-V target: ${TARGET} ==="
            cat > .config <<CONFIG_EOF
          # CONFIGURATION FOR RISC-V
          CT_OBSOLETE=y
          CT_EXPERIMENTAL=y
          CT_ALLOW_BUILD_AS_ROOT=y
          CT_ALLOW_BUILD_AS_ROOT_SURE=y
          CT_LOG_LEVEL_MAX="INFO"
          CT_LOG_PROGRESS_BAR=n
          CT_LOG_TO_FILE=y
          CT_LOG_FILE_COMPRESS=y
          CT_LOCAL_TARBALLS_DIR="${ROOT_DIR}/.build/tarballs"
          CT_SAVE_TARBALLS=y
          CT_OVERLAY_LOCATION="${ROOT_DIR}/crosstool-NG/overlays"
          CT_PREFIX_DIR="${ROOT_DIR}/x-tools/${TARGET}"
          CT_PARALLEL_JOBS=$(nproc)
          CT_USE_PIPES=y
          CT_LOAD=""
          
          # --- ARCHITECTURE: RISC-V ---
          CT_ARCH="riscv"
          CT_ARCH_RISCV=y
          CT_ARCH_64=n
          CT_ARCH_FLOAT_ABI=""
          CT_ARCH_SUFFIX="32"
          
          # --- KERNEL: BARE METAL (FIXED) ---
          CT_BARE_METAL=y
          CT_KERNEL="bare-metal"
          CT_KERNEL_bare_metal=y

          # --- TOOLCHAIN OPTIONS ---
          CT_TARGET_VENDOR="${VENDOR}"
          CT_TARGET_SYS="elf"
          CT_CC_LANG_CXX=y
          CT_LIBC="newlib"
          CT_LIBC_NEWLIB=y
          CT_LIBC_VERSION="4.3.0.20230120"
          CT_LIBC_NEWLIB_IO_FLOAT=y
          CT_LIBC_NEWLIB_EXTRA_SECTIONS=y
          CT_LIBC_NEWLIB_NANO_FORMATTED_IO=y
          CT_BINUTILS="y"
          CT_BINUTILS_VERSION="2.41"
          CT_GCC="y"
          CT_GCC_VERSION="15.2.0"
          CT_GCC_LANGUAGES="c,c++"
          
          # --- DISABLE TEST SUITE ---
          CT_TEST_SUITE_GCC=n

          # --- LIBRARIES ---
          CT_GMP="y"
          CT_GMP_VERSION="6.3.0"
          CT_MPFR="y"
          CT_MPFR_VERSION="4.2.1"
          CT_MPC="y"
          CT_MPC_VERSION="1.3.1"
          CT_ISL="y"
          CT_ISL_VERSION="0.19"
          CT_ZLIB="y"
          CT_ZLIB_VERSION="1.3.1"
          CT_ZSTD="y"
          CT_ZSTD_VERSION="1.5.6"
          CT_GDB="y"
          CT_GDB_VERSION="13.2"
          
          # --- OVERLAYS ---
          CT_OVERLAY_NAME="${OVERLAY}"
          CT_OVERLAY_BUNDLED=y
          CT_OVERLAY_DOWNLOAD=y
          CT_STRIP_HOST_TOOLCHAIN_EXECUTABLES=y

          # --- STATIC BUILD (NUCLEAR) ---
          CT_STATIC_TOOLCHAIN=y
          CT_WANTS_STATIC_LINK=y
          CT_CC_CX_LDFLAGS="-static -Wl,-Bstatic"
          CT_LDFLAGS_FOR_HOST="-static -Wl,-Bstatic"
          CT_CC_STATIC_LIBSTDCXX=y
          CT_CC_STATIC_LIBGCC=y
          CT_STATIC_LIBS=y
          CONFIG_EOF
          else
            echo "ERROR: Unknown architecture: ${ARCH}"
            exit 1
          fi

          echo "=== [ALPINE] Validasi Konfigurasi ==="
          echo "Target: ${TARGET}"
          
          echo "Running oldconfig..."
          # Menggunakan 'yes n' untuk menjawab NO pada pertanyaan baru (seperti test suite jika ada)
          yes "n" | ./ct-ng oldconfig 2>&1 | tail -50

          echo "=== [ALPINE] Building... ==="
          unset CFLAGS CXXFLAGS LDFLAGS CPPFLAGS
          export CT_ALLOW_BUILD_AS_ROOT=y
          export CT_ALLOW_BUILD_AS_ROOT_SURE=y
          
          JOBS=$(nproc)
          echo "Building with $JOBS jobs..."
          ./ct-ng build.$JOBS
          
          echo "=== [ALPINE] Validasi Deep (Cek cc1) ==="
          BIN_DIR="${ROOT_DIR}/x-tools/${TARGET}"
          
          COMPILER="${BIN_DIR}/bin/${TARGET}-gcc"
          if [ -f "$COMPILER" ]; then
            echo "Compiler ditemukan: $COMPILER"
            file "$COMPILER"
          else
            echo "WARNING: Compiler tidak ditemukan"
          fi
          
          CC1_PATH=$(find $BIN_DIR -name cc1 -o -name cc1plus | head -n 1)
          if [ -n "$CC1_PATH" ]; then
             echo "Checking binary: $CC1_PATH"
             file "$CC1_PATH"
          fi

          echo "=== [ALPINE] Packaging ==="
          cd ${ROOT_DIR}/x-tools
          TAR_NAME="${TARGET}-gcc15_2_0-android-native-nuclear.tar.gz"
          tar --hard-dereference --preserve-permissions -czf ${ROOT_DIR}/artifacts/$TAR_NAME ${TARGET}
          
          echo "Done. Artifact: ${ROOT_DIR}/artifacts/$TAR_NAME"
          EOF
          
          chmod +x build_script.sh

      - name: 3. Jalankan Docker
        run: |
          echo "Running Docker Build for ${{ matrix.target.name }}..."
          docker run --rm --privileged \
            -v "${{ github.workspace }}:/workspace" \
            -w "/workspace" \
            -e CROSSTOOL_NG_VERSION_ARG="$CROSSTOOL_NG_VERSION" \
            -e TARGET_ARG="${{ matrix.target.name }}" \
            -e ARCH_ARG="${{ matrix.target.arch }}" \
            -e VENDOR_ARG="${{ matrix.target.vendor }}" \
            -e CORE_ARG="${{ matrix.target.core }}" \
            -e OVERLAY_ARG="${{ matrix.target.overlay }}" \
            alpine:3.17 \
            /bin/sh /workspace/build_script.sh

      - name: 4. Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-${{ matrix.target.name }}-android-native-nuclear
          path: artifacts/*.tar.gz
          retention-days: 30
          
      - name: 5. Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ matrix.target.name }}
          path: |
            crosstool-NG/build.log
            crosstool-NG/.config

  combine-artifacts:
    runs-on: ubuntu-latest
    needs: build-native-nuclear
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: toolchain-*-android-native-nuclear
          path: downloaded-artifacts
          merge-multiple: true

      - name: Combine into ZIP
        run: |
          mkdir -p combined
          mv downloaded-artifacts/*.tar.gz combined/
          zip -r all-esp-toolchains-android-native-nuclear.zip combined/
          
      - name: Upload Combined ZIP
        uses: actions/upload-artifact@v4
        with:
          name: all-esp-toolchains-android-native-nuclear
          path: all-esp-toolchains-android-native-nuclear.zip
          retention-days: 30
