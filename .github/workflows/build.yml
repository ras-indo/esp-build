name: ðŸŽ¬ AI Director (Anti-Fail & Auto-Retry)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'URL Video MP4'
        required: true
        default: 'https://api.vidssave.com/api/contentsite_api/media/download_redirect?request=sgRpmKL3iNBpyIDr4IgGHBXJiSxcf0EYQuGexs_6KdEalT5ycrs3ffYBEZXevrdUBcrNn6iDw8MfLNTFhlNy7biCIOWf4sDWWBA_S3Gc0ACg1ZPIBzwNN6iyUU-0-PuEErnV6vklMuUiHCyNARF0XKYdjAEXIFyrKF3ytFZL3SURwBQ6zqTIxoinSGmbNRzuDj7GLLN2-qE4j55wtrmuN0sRuMHC3v3eqf14UHFW6OQMmpQ5sIwzvVB6Y5OhROhLgjaA0g8XRTd1z8-rT37YaXo2Y1N59CFMiBNLYoMKlQY-ogHXajXJ3IPsDSTl679jtoOgZpQQY4lq8X-k8lRdgZ5x16iwKPU9AC5d20FwHAFwPaA6sqqj6Sulox0JtTHVQT3xcaUUJowztbrK3N1wClY_bp0pTnhFn4ntpiJhobshFeQwTW0cvTh7u-DnwrB6zF3N3uAfdG9YkBFZZfMIps_fqAN_JZe1TE8Xy6dOcm1cAkp4CQA-6VSb2h75I3aACfjLy872k1vGM7UyG_aS1MqWJUICirs_GRhll-ZswtvtiONJHwWROte6JB-8vU4YEOzzqQAnMb6vwwKFoFArv6XjRP9hX__3UF6yn8R7YYtp9bMuc53-ovjN9sdZoX02'
      num_shorts:
        description: 'Target Jumlah Klip'
        required: false
        default: '5'

jobs:
  director-retry-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Studio
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Install AI Libraries
        run: |
          python -m pip install --upgrade pip
          python -m pip install -q torch numpy
          python -m pip install -q yt-dlp ffmpeg-python tiktoken
          python -m pip install -q langchain-core langchain-openai langchain-community
          python -m pip install -q git+https://github.com/openai/whisper.git

      - name: Run Resilient Director Script
        run: |
          cat > ai_director.py << 'EOF'
          import os
          import sys
          import json
          import re
          import subprocess
          import gc
          import time
          import torch
          import whisper
          from pathlib import Path

          # --- LANGCHAIN ---
          try:
              from langchain_openai import ChatOpenAI
              from langchain_core.prompts import ChatPromptTemplate
              from langchain_core.output_parsers import JsonOutputParser
          except ImportError:
              sys.exit("Critical: LangChain modules not found.")

          # === CONFIGURATION ===
          API_KEY = "Kontolondon"
          API_BASE = "https://tes-coral.vercel.app/v1/"
          
          VIDEO_URL = os.environ.get("VIDEO_URL")
          NUM_CLIPS = int(os.environ.get("NUM_SHORTS", 5))
          
          WORKDIR = Path("workspace")
          WORKDIR.mkdir(exist_ok=True)
          OUTDIR = Path("output")
          OUTDIR.mkdir(parents=True, exist_ok=True)
          VIDEO_PATH = WORKDIR / "source.mp4"

          # === 1. HARDWARE CHECK ===
          def get_device():
              if torch.cuda.is_available():
                  print(f"ðŸ–¥ï¸  GPU MODE: {torch.cuda.get_device_name(0)}")
                  return "cuda"
              print("ðŸ–¥ï¸  CPU MODE (Standard)")
              return "cpu"

          DEVICE = get_device()

          # === 2. DOWNLOAD ===
          def download_source():
              print("â¬‡ï¸  Fetching Video...")
              subprocess.run(["yt-dlp", VIDEO_URL, "-o", str(VIDEO_PATH), "--force-overwrites"], stdout=subprocess.DEVNULL)
              if not VIDEO_PATH.exists() or VIDEO_PATH.stat().st_size < 1000:
                  subprocess.run(["curl", "-L", VIDEO_URL, "-o", str(VIDEO_PATH)])
              if not VIDEO_PATH.exists(): raise Exception("Download Failed")
              print("âœ… Video Acquired.")

          # === 3. WHISPER (EARS) ===
          def listen_to_video():
              print("ðŸ‘‚ Whisper Medium (Listening)...")
              try:
                  model = whisper.load_model("medium", device=DEVICE)
                  result = model.transcribe(str(VIDEO_PATH), fp16=(DEVICE=="cuda"), verbose=False)
                  
                  # RAM CLEANUP
                  del model
                  gc.collect()
                  if DEVICE == "cuda": torch.cuda.empty_cache()
                  
                  return result["segments"]
              except Exception as e:
                  print(f"âŒ Audio Error: {e}")
                  sys.exit(1)

          # === 4. THE AI DIRECTOR (WITH AUTO-RETRY) ===
          def director_decision(segments):
              print("ðŸ§  AI Director & Advisor are conferring...")
              
              full_text = ""
              for s in segments:
                  full_text += f"[{int(s['start'])}s] {s['text']}\n"

              llm = ChatOpenAI(
                  model="gpt-4",
                  temperature=0.2, 
                  openai_api_key=API_KEY,
                  openai_api_base=API_BASE
              )
              
              parser = JsonOutputParser()

              template = """
              Anda adalah TIM PRODUKSI VIDEO (ADVISOR + EDITOR).
              
              TUGAS: Analisis transkrip, cari {num_clips} momen viral terbaik.

              INSTRUKSI:
              1. Cari Hook Kuat & Emosi.
              2. Hindari intro/outro channel.
              3. Timestamp harus presisi (jangan potong kata).
              4. Berikan judul clickbait & caption sosmed.

              OUTPUT WAJIB JSON (List):
              [
                {{
                  "start_time": 10.5,
                  "end_time": 40.0,
                  "title": "Judul Viral",
                  "viral_analysis": {{ "hook": "...", "score": 90 }},
                  "social_media": {{ "caption": "...", "hashtags": ["#fyp"] }}
                }}
              ]

              TRANSKRIP:
              {transcript}
              """

              prompt = ChatPromptTemplate.from_template(template)
              msgs = prompt.format_messages(num_clips=NUM_CLIPS, transcript=full_text[:18000])

              # === LOGIKA AUTO-RETRY (ANTI GAGAL 504) ===
              MAX_RETRIES = 10
              for attempt in range(1, MAX_RETRIES + 1):
                  try:
                      print(f"ðŸ”„ Percobaan ke-{attempt} menghubungi AI Brain...")
                      res = llm.invoke(msgs)
                      
                      # Cek validitas respon
                      if not res.content:
                          raise ValueError("Empty Response from AI")
                          
                      print("âœ… Keputusan Direksi Diterima.")
                      data = parser.parse(res.content)
                      
                      if isinstance(data, dict): return [data]
                      if isinstance(data, list): return data
                      return []

                  except Exception as e:
                      error_msg = str(e)
                      print(f"âš ï¸ Terjadi Kesalahan: {error_msg}")
                      
                      # Jika errornya 504 (Timeout), 502 (Bad Gateway), atau Connection Error
                      if "504" in error_msg or "502" in error_msg or "Connection" in error_msg or "timeout" in error_msg.lower():
                          wait_time = attempt * 1 # Exponential Backoff (1s, 6s, 9s...)
                          print(f"â³ Server sibuk (504/Timeout). Menunggu {wait_time} detik sebelum mencoba lagi...")
                          time.sleep(wait_time)
                      else:
                          # Jika error kodingan/fatal, coba sekali lagi lalu break jika gagal terus
                          if attempt == MAX_RETRIES:
                              print("âŒ Gagal total setelah percobaan maksimal.")
                              sys.exit(1)
                          print("â³ Retrying generic error...")
                          time.sleep(2)
              
              return []

          # === 5. EXPORT & NAMING ===
          def sanitize_name(name):
              clean = re.sub(r'[^a-zA-Z0-9]', '_', name)
              clean = re.sub(r'_+', '_', clean)
              return clean.strip('_')

          def production(clips):
              print("âœ‚ï¸  Produksi Dimulai...")
              
              if not clips:
                  print("âš ï¸ Data klip kosong. Tidak ada yang diproduksi.")
                  sys.exit(1)

              for clip in clips:
                  try:
                      s = float(clip["start_time"])
                      e = float(clip["end_time"])
                      dur = e - s
                      
                      if dur < 5: continue

                      raw_title = clip.get("title", "Untitled")
                      safe_name = sanitize_name(raw_title)
                      if len(safe_name) < 3: safe_name = f"Viral_Clip_{int(s)}"
                      
                      vid_fname = f"{safe_name}.mp4"
                      json_fname = f"{safe_name}.json"
                      
                      vid_path = OUTDIR / vid_fname
                      json_path = OUTDIR / json_fname

                      cmd = [
                          "ffmpeg", "-y", "-ss", str(s), "-i", str(VIDEO_PATH),
                          "-t", str(dur), "-c:v", "libx264", "-preset", "fast",
                          "-c:a", "aac", str(vid_path)
                      ]
                      subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                      
                      meta_content = {
                          "file_info": {
                              "filename": vid_fname,
                              "duration_sec": round(dur, 2)
                          },
                          "content_strategy": {
                              "title": clip.get("title"),
                              "analysis": clip.get("viral_analysis"),
                          },
                          "social_ready": clip.get("social_media"),
                          "ai_engine": "Director Mode (Auto-Retry)"
                      }

                      with open(json_path, "w", encoding="utf-8") as f:
                          json.dump(meta_content, f, indent=2, ensure_ascii=False)
                          
                      print(f"âœ¨ Exported: {vid_fname}")
                      
                  except Exception as ex:
                      print(f"âš ï¸ Failed to export clip: {ex}")

          if __name__ == "__main__":
              download_source()
              segs = listen_to_video()
              if not segs: sys.exit(1)
              
              # Loop retry sudah ada di dalam fungsi ini
              decisions = director_decision(segs)
              
              production(decisions)
              print("âœ… SEMUA SELESAI.")
          EOF

      - name: Run Director
        env:
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          NUM_SHORTS: ${{ github.event.inputs.num_shorts }}
        run: python ai_director.py

      - name: Upload Hasil Produksi
        uses: actions/upload-artifact@v4
        with:
          name: Viral_Shorts_Pack
          path: output/
          if-no-files-found: error
